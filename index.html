<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</title>
  <link rel="manifest" href="/manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
    .module { margin-bottom: 20px; padding: 15px; background: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; }
    input, select, button { padding: 8px; margin: 5px; border-radius: 3px; border: 1px solid #ccc; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    ul { list-style: none; padding: 0; }
    li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .error { color: red; font-size: 0.8em; }
    .profile-card { display: flex; align-items: center; padding: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
    .profile-card img { width: 50px; height: 50px; border-radius: 50%; margin-right: 10px; }
    .collapsible { display: none; }
    .collapsible.active { display: block; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 5px; max-width: 90%; max-height: 90%; overflow-y: auto; }
    .modal.active { display: flex; }
    canvas { max-width: 100%; }
    .finance-container { display: flex; justify-content: space-between; }
    .finance-column { width: 48%; }
    .strategy-tree { display: flex; flex-direction: column; align-items: center; }
    .strategy-node { padding: 10px; border: 1px solid #ddd; margin: 5px; border-radius: 5px; }
    .strategy-branch { display: flex; justify-content: space-around; width: 100%; }
  </style>
</head>
<body>
  <!-- –û–∫—Ä—É–∂–µ–Ω–∏–µ -->
  <div class="module" id="environment-module">
    <h2>–û–∫—Ä—É–∂–µ–Ω–∏–µ</h2>
    <input type="text" id="person-name" placeholder="–ò–º—è —á–µ–ª–æ–≤–µ–∫–∞">
    <select id="person-status">
      <option value="loyal">–õ–æ—è–ª—å–Ω—ã–π</option>
      <option value="neutral">–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π</option>
      <option value="hostile">–í—Ä–∞–∂–¥–µ–±–Ω—ã–π</option>
    </select>
    <select id="person-tags" multiple>
      <option value="üí∞ –†–µ—Å—É—Ä—Å">üí∞ –†–µ—Å—É—Ä—Å</option>
      <option value="ü™® –ë–∞–ª–ª–∞—Å—Ç">ü™® –ë–∞–ª–ª–∞—Å—Ç</option>
      <option value="üß† –í–Ω—É—à–∞–µ–º—ã–π">üß† –í–Ω—É—à–∞–µ–º—ã–π</option>
      <option value="üó£Ô∏è –ë–æ–ª—Ç—É–Ω">üó£Ô∏è –ë–æ–ª—Ç—É–Ω</option>
      <option value="‚úùÔ∏è –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–π">‚úùÔ∏è –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–π</option>
      <option value="üß© –ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä">üß© –ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä</option>
      <option value="üß≤ –ó–∞–≤–∏—Å—Ç–ª–∏–≤—ã–π">üß≤ –ó–∞–≤–∏—Å—Ç–ª–∏–≤—ã–π</option>
      <option value="ü¶ä –•–∏—Ç—Ä—ã–π">ü¶ä –•–∏—Ç—Ä—ã–π</option>
    </select>
    <input type="number" id="person-karma" placeholder="–ö–∞—Ä–º–∞ (0)" value="0">
    <select id="person-connections" multiple>
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤—è–∑–∏</option>
    </select>
    <button onclick="addPerson()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button onclick="showHelp('environment')">–°–ø—Ä–∞–≤–∫–∞</button>
    <div class="error" id="environment-error"></div>
    <ul id="person-list"></ul>
  </div>

  <!-- –§–∏–∑–æ -->
  <div class="module" id="fitness-module">
    <h2>–§–∏–∑–æ</h2>
    <input type="text" id="exercise-type" placeholder="–¢–∏–ø (–Ω–∞–ø—Ä., –û—Ç–∂–∏–º–∞–Ω–∏—è)">
    <input type="number" id="exercise-result" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–∞–ø—Ä., 20)">
    <button onclick="addExercise()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
    <button onclick="toggleCollapsible('exercise-list')">–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å</button>
    <button onclick="showHelp('fitness')">–°–ø—Ä–∞–≤–∫–∞</button>
    <div class="error" id="fitness-error"></div>
    <ul id="exercise-list" class="collapsible"></ul>
    <canvas id="fitness-chart"></canvas>
  </div>

  <!-- –î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã -->
  <div class="module" id="finance-module">
    <h2>–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã</h2>
    <div class="finance-container">
      <div class="finance-column">
        <h3>–î–æ—Ö–æ–¥—ã</h3>
        <input type="number" id="income-amount" placeholder="–°—É–º–º–∞">
        <input type="text" id="income-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
        <button onclick="addTransaction('income')">–ó–∞–ø–∏—Å–∞—Ç—å</button>
        <ul id="income-list"></ul>
      </div>
      <div class="finance-column">
        <h3>–†–∞—Å—Ö–æ–¥—ã</h3>
        <input type="number" id="expense-amount" placeholder="–°—É–º–º–∞">
        <input type="text" id="expense-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
        <button onclick="addTransaction('expense')">–ó–∞–ø–∏—Å–∞—Ç—å</button>
        <ul id="expense-list"></ul>
      </div>
    </div>
    <div id="finance-percentage"></div>
    <button onclick="showFinanceLog()">–ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Å—å –ª–æ–≥</button>
    <button onclick="showHelp('finance')">–°–ø—Ä–∞–≤–∫–∞</button>
    <div class="error" id="finance-error"></div>
    <canvas id="finance-chart"></canvas>
  </div>

  <!-- –ê—Ä—Ö–µ—Ç–∏–ø—ã -->
  <div class="module" id="archetype-module">
    <h2>–ê—Ä—Ö–µ—Ç–∏–ø—ã</h2>
    <button onclick="openArchetypeModal()">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>
    <button onclick="showHelp('archetype')">–°–ø—Ä–∞–≤–∫–∞</button>
    <div id="archetype-result"></div>
    <div class="error" id="archetype-error"></div>
  </div>

  <!-- –ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ -->
  <div class="module" id="strategy-module">
    <h2>–ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h2>
    <button onclick="openStrategyModal()">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é</button>
    <button onclick="showHelp('strategy')">–°–ø—Ä–∞–≤–∫–∞</button>
    <div class="error" id="strategy-error"></div>
    <div id="strategy-list" class="strategy-tree"></div>
  </div>

  <!-- –¢–µ–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
  <div class="module" id="analytics-module">
    <h2>–¢–µ–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
    <button onclick="window.renderAnalytics()">–û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É</button>
    <button onclick="showHelp('analytics')">–°–ø—Ä–∞–≤–∫–∞</button>
    <div id="analytics-results"></div>
    <div class="error" id="analytics-error"></div>
  </div>

  <!-- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è -->
  <div class="module" id="reminders-module">
    <h2>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</h2>
    <input type="text" id="reminder-text" placeholder="–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è">
    <button onclick="addReminder()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button onclick="showHelp('reminders')">–°–ø—Ä–∞–≤–∫–∞</button>
    <div class="error" id="reminders-error"></div>
    <ul id="reminder-list"></ul>
  </div>

  <!-- –õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
  <div class="module" id="activity-module">
    <h2>–õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
    <button onclick="toggleCollapsible('activity-list')">–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å</button>
    <button onclick="showHelp('activity')">–°–ø—Ä–∞–≤–∫–∞</button>
    <div class="error" id="activity-error"></div>
    <ul id="activity-list" class="collapsible"></ul>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤ -->
  <template id="archetype-modal-template">
    <div class="modal" id="archetype-modal">
      <div class="modal-content">
        <h2>–¢–µ—Å—Ç –Ω–∞ –∞—Ä—Ö–µ—Ç–∏–ø</h2>
        <div id="questions"></div>
        <button onclick="submitArchetype()">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button>
        <button onclick="closeModal('archetype-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div class="error" id="archetype-modal-error"></div>
      </div>
    </div>
  </template>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ -->
  <template id="strategy-modal-template">
    <div class="modal" id="strategy-modal">
      <div class="modal-content">
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é</h2>
        <input type="text" id="strategy-goal" placeholder="–¶–µ–ª—å">
        <select id="strategy-people">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞</option>
        </select>
        <input type="text" id="strategy-resources" placeholder="–†–µ—Å—É—Ä—Å—ã">
        <input type="text" id="strategy-levers" placeholder="–†—ã—á–∞–≥–∏">
        <input type="text" id="strategy-obstacles" placeholder="–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è">
        <input type="text" id="strategy-mechanisms" placeholder="–ú–µ—Ö–∞–Ω–∏–∑–º—ã">
        <select id="strategy-status">
          <option value="plan">–ü–ª–∞–Ω</option>
          <option value="in-progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
          <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
        </select>
        <button onclick="addStrategy()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="closeModal('strategy-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div class="error" id="strategy-modal-error"></div>
      </div>
    </div>
  </template>

  <script>
    // –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function showError(module, message) {
      const errorDiv = document.getElementById(`${module}-error`);
      errorDiv.textContent = message;
    }

    function logActivity(message) {
      try {
        const activityList = document.getElementById('activity-list');
        let log = JSON.parse(localStorage.getItem('activityLog') || '[]');
        const timestamp = new Date().toLocaleString();
        log.push(`${timestamp}: ${message}`);
        localStorage.setItem('activityLog', JSON.stringify(log));
        activityList.innerHTML = log.map(item => `<li>${item}</li>`).join('');
        showError('activity', '');
      } catch (e) {
        showError('activity', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –ª–æ–≥: ' + e.message);
      }
    }

    function toggleCollapsible(id) {
      const element = document.getElementById(id);
      element.classList.toggle('active');
    }

    function openModal(templateId, modalId) {
      const template = document.getElementById(templateId);
      const modal = template.content.cloneNode(true).querySelector('.modal');
      modal.id = modalId;
      document.body.appendChild(modal);
      modal.classList.add('active');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.remove();
      }
    }

    function showHelp(module) {
      const helpText = {
        environment: '–î–æ–±–∞–≤–ª—è–π—Ç–µ –ª—é–¥–µ–π, —É–∫–∞–∑—ã–≤–∞—è –∏–º—è, —Å—Ç–∞—Ç—É—Å, —Ç–µ–≥–∏, –∫–∞—Ä–º—É –∏ —Å–≤—è–∑–∏. –¢–µ–≥–∏ –≤–ª–∏—è—é—Ç –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫—É. –ö–∞—Ä–º–∞: +5 –∑–∞ —Ö–æ—Ä–æ—à–µ–µ, -10 –∑–∞ –ø–ª–æ—Ö–æ–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: "üí∞ –†–µ—Å—É—Ä—Å: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤", "ü™® –ë–∞–ª–ª–∞—Å—Ç: –°–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫ –º–∏–Ω–∏–º—É–º—É".',
        fitness: '–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (—Ç–∏–ø –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç). –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–µ–≥ —Å –±–µ–≥–æ–º). –°–ø–∏—Å–æ–∫ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏.',
        finance: '–í–≤–æ–¥–∏—Ç–µ –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã. –ò—Ç–æ–≥–∏ –∑–∞ 30 –¥–Ω–µ–π –∏ –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –ì—Ä–∞—Ñ–∏–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É.',
        archetype: '–ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç –Ω–∞ –∞—Ä—Ö–µ—Ç–∏–ø, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å —Å–µ–±—è. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°—Ç—Ä–∞—Ç–µ–≥: –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–∏—Ñ –æ —Å–µ–±–µ").',
        strategy: '–î–æ–±–∞–≤–ª—è–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (—Ü–µ–ª—å, –ª—é–¥–∏, —Ä–µ—Å—É—Ä—Å—ã, —Ä—ã—á–∞–≥–∏, –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è, –º–µ—Ö–∞–Ω–∏–∑–º—ã). –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ –≤–∏–¥–µ –¥–µ—Ä–µ–≤–∞. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: "–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä—ã—á–∞–≥–∏ –≤–ª–∏—è–Ω–∏—è".',
        analytics: '–û–±–Ω–æ–≤–ª—è–π—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –∑–∞–¥–∞—á–∞–º, –ª—é–¥—è–º, —Ñ–∏–Ω–∞–Ω—Å–∞–º. –û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ "–ö–æ–¥–µ–∫—Å–µ –•–∏—á–Ω–∏–∫–∞".',
        reminders: '–î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã. –û–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ.',
        activity: '–õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.'
      };
      alert(helpText[module]);
    }

    // –û–∫—Ä—É–∂–µ–Ω–∏–µ
    function initEnvironment() {
      try {
        const personName = document.getElementById('person-name');
        const personStatus = document.getElementById('person-status');
        const personTags = document.getElementById('person-tags');
        const personKarma = document.getElementById('person-karma');
        const personConnections = document.getElementById('person-connections');
        const personList = document.getElementById('person-list');
        let people = JSON.parse(localStorage.getItem('people') || '[]');

        // –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: –¥–æ–±–∞–≤–ª—è–µ–º tags –∏ connections, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
        people = people.map(person => ({
          ...person,
          tags: Array.isArray(person.tags) ? person.tags : [],
          connections: Array.isArray(person.connections) ? person.connections : []
        }));
        localStorage.setItem('people', JSON.stringify(people));

        const renderPeople = () => {
          try {
            personList.innerHTML = '';
            people.forEach((person, index) => {
              const tagsDisplay = person.tags.length > 0 ? person.tags.join(', ') : '–Ω–µ—Ç';
              const connectionsDisplay = person.connections.length > 0 ? person.connections.join(', ') : '–Ω–µ—Ç';
              const li = document.createElement('li');
              li.className = 'profile-card';
              li.innerHTML = `
                <img src="https://via.placeholder.com/50" alt="Profile">
                <div>
                  <strong>${person.name}</strong> (${person.status}, –ö–∞—Ä–º–∞: ${person.karma})<br>
                  –ú–µ—Ç–∫–∏: ${tagsDisplay}<br>
                  –°–≤—è–∑–∏: ${connectionsDisplay}<br>
                  <button onclick="adjustKarma(${index}, 5)">+5</button>
                  <button onclick="adjustKarma(${index}, -10)">-10</button>
                  <button onclick="deletePerson(${index})">‚ùå</button>
                </div>
              `;
              personList.appendChild(li);
            });
            updateConnectionsSelect();
            updateStrategyPeopleSelect();
            window.renderAnalytics();
            showError('environment', '');
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫: ' + e.message);
          }
        };

        const updateConnectionsSelect = () => {
          personConnections.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤—è–∑–∏</option>';
          people.forEach(person => {
            const option = document.createElement('option');
            option.value = person.name;
            option.textContent = person.name;
            personConnections.appendChild(option);
          });
        };

window.addPerson = () => {
          try {
            const name = personName.value.trim();
            const status = personStatus.value;
            const tags = Array.from(personTags.selectedOptions).map(opt => opt.value);
            const karma = parseInt(personKarma.value) || 0;
            const connections = Array.from(personConnections.selectedOptions).map(opt => opt.value);
            if (name) {
              people.push({ name, status, tags, karma, connections });
              localStorage.setItem('people', JSON.stringify(people));
              console.log('–î–æ–±–∞–≤–ª–µ–Ω —á–µ–ª–æ–≤–µ–∫:', { name, status, tags, karma, connections });
              personName.value = '';
              personStatus.value = 'loyal';
              Array.from(personTags.options).forEach(option => option.selected = false);
              personKarma.value = '0';
              Array.from(personConnections.options).forEach(option => option.selected = false);
              renderPeople();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω —á–µ–ª–æ–≤–µ–∫: ${name}`);
              showError('environment', '');
            } else {
              showError('environment', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
            }
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞: ' + e.message);
          }
        };

        window.adjustKarma = (index, change) => {
          try {
            people[index].karma = Math.max(-100, Math.min(100, people[index].karma + change));
            localStorage.setItem('people', JSON.stringify(people));
            console.log('–ö–∞—Ä–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞:', people[index]);
            renderPeople();
            logActivity(`–ò–∑–º–µ–Ω–µ–Ω–∞ –∫–∞—Ä–º–∞ –¥–ª—è ${people[index].name}: ${people[index].karma}`);
            showError('environment', '');
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ä–º—É: ' + e.message);
          }
        };

        window.deletePerson = (index) => {
          try {
            const name = people[index].name;
            people.splice(index, 1);
            localStorage.setItem('people', JSON.stringify(people));
            console.log('–£–¥–∞–ª—ë–Ω —á–µ–ª–æ–≤–µ–∫:', name);
            renderPeople();
            logActivity(`–£–¥–∞–ª—ë–Ω —á–µ–ª–æ–≤–µ–∫: ${name}`);
            showError('environment', '');
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞: ' + e.message);
          }
        };

        renderPeople();
        updateConnectionsSelect();
        console.log('–û–∫—Ä—É–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –ª—é–¥–∏:', people);
      } catch (e) {
        showError('environment', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –§–∏–∑–æ
    function initFitness() {
      try {
        const exerciseType = document.getElementById('exercise-type');
        const exerciseResult = document.getElementById('exercise-result');
        const exerciseList = document.getElementById('exercise-list');
        const fitnessChart = document.getElementById('fitness-chart').getContext('2d');
        let exercises = JSON.parse(localStorage.getItem('exercises') || '[]');
        let chart;

        const renderExercises = () => {
          try {
            exerciseList.innerHTML = '';
            const types = [...new Set(exercises.map(e => e.type))];
            types.forEach(type => {
              const typeExercises = exercises.filter(e => e.type === type);
              const li = document.createElement('li');
              li.innerHTML = `
                ${type}: ${typeExercises.map(e => `${e.result} (${new Date(e.date).toLocaleDateString()})`).join(', ')}
                <button onclick="deleteExerciseType('${type}')">‚ùå</button>
              `;
              exerciseList.appendChild(li);
            });
            updateFitnessChart();
            showError('fitness', '');
          } catch (e) {
            showError('fitness', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ' + e.message);
          }
        };

        const updateFitnessChart = () => {
          try {
            const types = [...new Set(exercises.map(e => e.type))];
            const dates = [...new Set(exercises.map(e => new Date(e.date).toLocaleDateString()))];
            const datasets = types.map(type => ({
              label: type,
              data: dates.map(date => {
                const exercise = exercises.find(e => e.type === type && new Date(e.date).toLocaleDateString() === date);
                return exercise ? exercise.result : 0;
              }),
              borderColor: '#' + Math.floor(Math.random()*16777215).toString(16),
              fill: false
            }));

            if (chart) chart.destroy();
            chart = new Chart(fitnessChart, {
              type: 'line',
              data: { labels: dates, datasets },
              options: { scales: { y: { beginAtZero: true } } }
            });
            showError('fitness', '');
          } catch (e) {
            showError('fitness', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫: ' + e.message);
          }
        };

        window.addExercise = () => {
          try {
            const type = exerciseType.value.trim();
            const result = parseInt(exerciseResult.value);
            if (type && !isNaN(result) && result > 0) {
              exercises.push({ type, result, date: new Date().toISOString() });
              localStorage.setItem('exercises', JSON.stringify(exercises));
              exerciseType.value = '';
              exerciseResult.value = '';
              renderExercises();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: ${type}, ${result}`);
              showError('fitness', '');
            } else {
              showError('fitness', '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (>0)');
            }
          } catch (e) {
            showError('fitness', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: ' + e.message);
          }
        };

        window.deleteExerciseType = (type) => {
          try {
            exercises = exercises.filter(e => e.type !== type);
            localStorage.setItem('exercises', JSON.stringify(exercises));
            renderExercises();
            logActivity(`–£–¥–∞–ª–µ–Ω—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–∏–ø–∞: ${type}`);
            showError('fitness', '');
          } catch (e) {
            showError('fitness', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ' + e.message);
          }
        };

        renderExercises();
        console.log('–§–∏–∑–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
      } catch (e) {
        showError('fitness', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã
    function initFinance() {
      try {
        const incomeAmount = document.getElementById('income-amount');
        const incomeDescription = document.getElementById('income-description');
        const expenseAmount = document.getElementById('expense-amount');
        const expenseDescription = document.getElementById('expense-description');
        const incomeList = document.getElementById('income-list');
        const expenseList = document.getElementById('expense-list');
        const percentageText = document.getElementById('finance-percentage');
        const financeChart = document.getElementById('finance-chart').getContext('2d');
        let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        let chart;

        const renderTransactions = () => {
          try {
            incomeList.innerHTML = '';
            expenseList.innerHTML = '';
            const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const recentTransactions = transactions.filter(t => new Date(t.date) >= last30Days);

            recentTransactions.forEach((transaction, index) => {
              const li = document.createElement('li');
              li.innerHTML = `${transaction.amount} - ${transaction.description} <button onclick="deleteTransaction(${index})">‚ùå</button>`;
              if (transaction.type === 'income') {
                incomeList.appendChild(li);
              } else {
                expenseList.appendChild(li);
              }
            });

            const income = recentTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = recentTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const total = income + expense;
            const percentage = total ? (income / total * 100).toFixed(2) : 0;
            percentageText.textContent = `–î–æ—Ö–æ–¥—ã: ${income} | –†–∞—Å—Ö–æ–¥—ã: ${expense} | ${percentage}%`;
            percentageText.style.color = percentage > 50 ? 'green' : percentage == 50 ? 'yellow' : 'red';

            updateFinanceChart();
            window.renderAnalytics();
            showError('finance', '');
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ' + e.message);
          }
        };



const updateFinanceChart = () => {
          try {
            const dates = [...new Set(transactions.map(t => new Date(t.date).toLocaleDateString()))];
            const incomeData = dates.map(date => {
              return transactions
                .filter(t => t.type === 'income' && new Date(t.date).toLocaleDateString() === date)
                .reduce((sum, t) => sum + t.amount, 0);
            });
            const expenseData = dates.map(date => {
              return transactions
                .filter(t => t.type === 'expense' && new Date(t.date).toLocaleDateString() === date)
                .reduce((sum, t) => sum + t.amount, 0);
            });

            if (chart) chart.destroy();
            chart = new Chart(financeChart, {
              type: 'line',
              data: {
                labels: dates,
                datasets: [
                  { label: '–î–æ—Ö–æ–¥—ã', data: incomeData, borderColor: 'green', fill: false },
                  { label: '–†–∞—Å—Ö–æ–¥—ã', data: expenseData, borderColor: 'red', fill: false }
                ]
              },
              options: { scales: { y: { beginAtZero: true } } }
            });
            showError('finance', '');
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫: ' + e.message);
          }
        };

        window.addTransaction = (type) => {
          try {
            const amount = parseFloat(type === 'income' ? incomeAmount.value : expenseAmount.value);
            const description = (type === 'income' ? incomeDescription.value : expenseDescription.value).trim();
            if (!isNaN(amount) && amount > 0 && description) {
              transactions.push({ amount, type, description, date: new Date().toISOString() });
              localStorage.setItem('transactions', JSON.stringify(transactions));
              if (type === 'income') {
                incomeAmount.value = '';
                incomeDescription.value = '';
              } else {
                expenseAmount.value = '';
                expenseDescription.value = '';
              }
              renderTransactions();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: ${type}, ${amount}`);
              showError('finance', '');
            } else {
              showError('finance', '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (>0) –∏ –æ–ø–∏—Å–∞–Ω–∏–µ');
            }
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é: ' + e.message);
          }
        };

        window.deleteTransaction = (index) => {
          try {
            const transaction = transactions[index];
            transactions.splice(index, 1);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderTransactions();
            logActivity(`–£–¥–∞–ª–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: ${transaction.type}, ${transaction.amount}`);
            showError('finance', '');
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é: ' + e.message);
          }
        };

        window.showFinanceLog = () => {
          try {
            const log = transactions.map(t => `${new Date(t.date).toLocaleString()}: ${t.type} - ${t.amount} (${t.description})`).join('\n');
            alert(log || '–õ–æ–≥ –ø—É—Å—Ç');
            logActivity('–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω –ª–æ–≥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
            showError('finance', '');
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ª–æ–≥: ' + e.message);
          }
        };

        renderTransactions();
        console.log('–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
      } catch (e) {
        showError('finance', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –ê—Ä—Ö–µ—Ç–∏–ø—ã
    function initArchetype() {
      try {
        const archetypeResult = document.getElementById('archetype-result');
        let archetype = localStorage.getItem('archetype') || '';
        if (archetype) {
          archetypeResult.innerHTML = `–í–∞—à –∞—Ä—Ö–µ—Ç–∏–ø: ${archetype}<br>${getArchetypeRecommendations(archetype)}`;
        }
        console.log('–ê—Ä—Ö–µ—Ç–∏–ø—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
      } catch (e) {
        showError('archetype', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    function openArchetypeModal() {
      try {
        openModal('archetype-modal-template', 'archetype-modal');
        const questionsDiv = document.getElementById('questions');
        const questions = [
          { text: '–ö–∞–∫ –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —Ä–µ—à–µ–Ω–∏—è?', options: ['–õ–æ–≥–∏–∫–∞', '–≠–º–æ—Ü–∏–∏', '–ò–Ω—Ç—É–∏—Ü–∏—è', '–ê–Ω–∞–ª–∏–∑'] },
          { text: '–ö–∞–∫ –≤—ã –æ–±—â–∞–µ—Ç–µ—Å—å —Å –ª—é–¥—å–º–∏?', options: ['–ü—Ä—è–º–æ', '–û—Å—Ç–æ—Ä–æ–∂–Ω–æ', '–ú–∞–Ω–∏–ø—É–ª—è—Ç–∏–≤–Ω–æ', '–û—Ç–∫—Ä—ã—Ç–æ'] },
          { text: '–í–∞—à–∞ —Ü–µ–ª—å –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ?', options: ['–ü–æ–±–µ–¥–∞', '–ö–æ–º–ø—Ä–æ–º–∏—Å—Å', '–ò–∑–±–µ–∂–∞–Ω–∏–µ', '–ö–æ–Ω—Ç—Ä–æ–ª—å'] },
          { text: '–ö–∞–∫ –≤—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ —Ä–∏—Å–∫—É?', options: ['–†–∏—Å–∫—É—é', '–ò–∑–±–µ–≥–∞—é', '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é', '–ü—Ä–∏–Ω–∏–º–∞—é'] },
          { text: '–í–∞—à–∞ —Ä–æ–ª—å –≤ –≥—Ä—É–ø–ø–µ?', options: ['–õ–∏–¥–µ—Ä', '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', '–°–æ–≤–µ—Ç–Ω–∏–∫', '–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å'] }
        ];

        questionsDiv.innerHTML = questions.map((q, i) => `
          <div>
            <p>${q.text}</p>
            ${q.options.map(opt => `
              <button onclick="selectAnswer(${i}, '${opt}')">${opt}</button>
            `).join('')}
          </div>
        `).join('');
        showError('archetype-modal', '');
      } catch (e) {
        showError('archetype-modal', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç: ' + e.message);
      }
    }

    window.selectAnswer = (questionIndex, answer) => {
      try {
        let answers = JSON.parse(localStorage.getItem('archetypeAnswers') || '{}');
        answers[questionIndex] = answer;
        localStorage.setItem('archetypeAnswers', JSON.stringify(answers));
        console.log('–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω:', { questionIndex, answer });
      } catch (e) {
        showError('archetype-modal', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç: ' + e.message);
      }
    };

    window.submitArchetype = () => {
      try {
        const answers = JSON.parse(localStorage.getItem('archetypeAnswers') || '{}');
        if (Object.keys(answers).length < 5) {
          showError('archetype-modal', '–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã');
          return;
        }
        const archetype = determineArchetype(answers);
        localStorage.setItem('archetype', archetype);
        document.getElementById('archetype-result').innerHTML = `–í–∞—à –∞—Ä—Ö–µ—Ç–∏–ø: ${archetype}<br>${getArchetypeRecommendations(archetype)}`;
        closeModal('archetype-modal');
        logActivity(`–û–ø—Ä–µ–¥–µ–ª—ë–Ω –∞—Ä—Ö–µ—Ç–∏–ø: ${archetype}`);
        showError('archetype', '');
      } catch (e) {
        showError('archetype-modal', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞—Ä—Ö–µ—Ç–∏–ø: ' + e.message);
      }
    };


function determineArchetype(answers) {
      const scores = {
        Strategist: 0,
        Manipulator: 0,
        Leader: 0,
        Observer: 0
      };
      if (answers[0] === '–õ–æ–≥–∏–∫–∞' || answers[0] === '–ê–Ω–∞–ª–∏–∑') scores.Strategist += 1;
      if (answers[1] === '–ú–∞–Ω–∏–ø—É–ª—è—Ç–∏–≤–Ω–æ') scores.Manipulator += 1;
      if (answers[2] === '–ü–æ–±–µ–¥–∞' || answers[2] === '–ö–æ–Ω—Ç—Ä–æ–ª—å') scores.Leader += 1;
      if (answers[3] === '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é') scores.Strategist += 1;
      if (answers[4] === '–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å') scores.Observer += 1;
      return Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
    }

    function getArchetypeRecommendations(archetype) {
      const recommendations = {
        Strategist: '–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–∏—Ñ –æ —Å–µ–±–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ö–æ–ª–æ–¥–Ω—ã–π —Ä–∞—Å—á—ë—Ç –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.',
        Manipulator: '–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —ç–º–æ—Ü–∏—è–º–∏ –¥—Ä—É–≥–∏—Ö. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏–ª–ª—é–∑–∏—é –≤—ã–±–æ—Ä–∞, –≤—ã–≥–æ–¥–Ω–æ–≥–æ –≤–∞–º.',
        Leader: '–ë—É–¥—å—Ç–µ –æ—Å—å—é, –≤–æ–∫—Ä—É–≥ –∫–æ—Ç–æ—Ä–æ–π –≤—Ä–∞—â–∞—é—Ç—Å—è. –ó–∞–¥–∞–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã.',
        Observer: '–ù–∞–±–ª—é–¥–∞–π—Ç–µ –∏ —Å–æ–±–∏—Ä–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –î–µ–π—Å—Ç–≤—É–π—Ç–µ —Å–∫—Ä—ã—Ç–Ω–æ, –Ω–æ —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ.'
      };
      return recommendations[archetype] || '–°–ª–µ–¥—É–π—Ç–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º —Ö–æ–ª–æ–¥–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞.';
    }

    // –ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    function initStrategy() {
      try {
        const strategyList = document.getElementById('strategy-list');
        let strategies = JSON.parse(localStorage.getItem('strategies') || '[]');

        window.updateStrategyPeopleSelect = () => {
          try {
            const peopleSelect = document.getElementById('strategy-people');
            const people = JSON.parse(localStorage.getItem('people') || '[]');
            peopleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞</option>';
            people.forEach(person => {
              const option = document.createElement('option');
              option.value = person.name;
              option.textContent = person.name;
              peopleSelect.appendChild(option);
            });
            showError('strategy', '');
          } catch (e) {
            showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ª—é–¥–µ–π: ' + e.message);
          }
        };

        const renderStrategies = () => {
          try {
            strategyList.innerHTML = '';
            strategies.forEach((strategy, index) => {
              const div = document.createElement('div');
              div.className = 'strategy-node';
              div.innerHTML = `
                <strong>–¶–µ–ª—å: ${strategy.goal}</strong> (–°—Ç–∞—Ç—É—Å: ${strategy.status}, –õ—é–¥–∏: ${strategy.people || '–Ω–µ—Ç'})<br>
                –†–µ—Å—É—Ä—Å—ã: ${strategy.resources || '–Ω–µ—Ç'}<br>
                <div class="strategy-branch">
                  <div class="strategy-node">–†—ã—á–∞–≥–∏: ${strategy.levers || '–Ω–µ—Ç'}</div>
                  <div class="strategy-node">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è: ${strategy.obstacles || '–Ω–µ—Ç'}</div>
                  <div class="strategy-node">–ú–µ—Ö–∞–Ω–∏–∑–º—ã: ${strategy.mechanisms || '–Ω–µ—Ç'}</div>
                </div>
                <button onclick="deleteStrategy(${index})">‚ùå</button>
              `;
              strategyList.appendChild(div);
            });
            window.renderAnalytics();
            showError('strategy', '');
          } catch (e) {
            showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ' + e.message);
          }
        };

        window.addStrategy = () => {
          try {
            const goal = document.getElementById('strategy-goal').value.trim();
            const people = document.getElementById('strategy-people').value;
            const resources = document.getElementById('strategy-resources').value.trim();
            const levers = document.getElementById('strategy-levers').value.trim();
            const obstacles = document.getElementById('strategy-obstacles').value.trim();
            const mechanisms = document.getElementById('strategy-mechanisms').value.trim();
            const status = document.getElementById('strategy-status').value;
            if (goal) {
              strategies.push({ goal, people, resources, levers, obstacles, mechanisms, status });
              localStorage.setItem('strategies', JSON.stringify(strategies));
              document.getElementById('strategy-goal').value = '';
              document.getElementById('strategy-people').value = '';
              document.getElementById('strategy-resources').value = '';
              document.getElementById('strategy-levers').value = '';
              document.getElementById('strategy-obstacles').value = '';
              document.getElementById('strategy-mechanisms').value = '';
              renderStrategies();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: ${goal}`);
              closeModal('strategy-modal');
              showError('strategy', '');
            } else {
              showError('strategy-modal', '–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏');
            }
          } catch (e) {
            showError('strategy-modal', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é: ' + e.message);
          }
        };

        window.deleteStrategy = (index) => {
          try {
            const goal = strategies[index].goal;
            strategies.splice(index, 1);
            localStorage.setItem('strategies', JSON.stringify(strategies));
            renderStrategies();
            logActivity(`–£–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: ${goal}`);
            showError('strategy', '');
          } catch (e) {
            showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é: ' + e.message);
          }
        };

        updateStrategyPeopleSelect();
        renderStrategies();
        console.log('–ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
      } catch (e) {
        showError('strategy', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    function openStrategyModal() {
      try {
        openModal('strategy-modal-template', 'strategy-modal');
        window.updateStrategyPeopleSelect();
        showError('strategy-modal', '');
      } catch (e) {
        showError('strategy-modal', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ' + e.message);
      }
    }

    // –¢–µ–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
    function initAnalytics() {
      try {
        const analyticsResults = document.getElementById('analytics-results');

        window.renderAnalytics = () => {
          try {
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const people = JSON.parse(localStorage.getItem('people') || '[]');
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const state = localStorage.getItem('userState') || 'focus';
            const now = new Date();
            const threeDaysAgo = new Date(now - 3 * 24 * 60 * 60 * 1000);

            let results = '<h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3><ul>';

            // –ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            const overdueTasks = tasks.filter(task => !task.completed && new Date(task.created) < threeDaysAgo);
            results += overdueTasks.length > 0
              ? `<li>–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (>3 –¥–Ω–µ–π): ${overdueTasks.map(t => t.text).join(', ')}</li>`
              : '<li>–ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</li>';

            // –õ—é–¥–∏ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π –∫–∞—Ä–º–æ–π
            const negativeKarma = people.filter(p => p.karma < 0);
            results += negativeKarma.length > 0
              ? `<li>–õ—é–¥–∏ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π –∫–∞—Ä–º–æ–π: ${negativeKarma.map(p => `${p.name} (${p.karma})`).join(', ')}</li>`
              : '<li>–ù–µ—Ç –ª—é–¥–µ–π —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π –∫–∞—Ä–º–æ–π</li>';

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–µ—Ç–∫–∞–º
            const tagRecommendations = {
              'üí∞ –†–µ—Å—É—Ä—Å': '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.',
              'ü™® –ë–∞–ª–ª–∞—Å—Ç': '–°–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫ –º–∏–Ω–∏–º—É–º—É.',
              'üß† –í–Ω—É—à–∞–µ–º—ã–π': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –∏–¥–µ–π.',
              'üó£Ô∏è –ë–æ–ª—Ç—É–Ω': '–ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.',
              '‚úùÔ∏è –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–π': '–£–≤–∞–∂–∞–π—Ç–µ —É–±–µ–∂–¥–µ–Ω–∏—è.',
              'üß© –ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä': '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.',
              'üß≤ –ó–∞–≤–∏—Å—Ç–ª–∏–≤—ã–π': '–ò–∑–±–µ–≥–∞–π—Ç–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è —É—Å–ø–µ—Ö–æ–≤.',
              'ü¶ä –•–∏—Ç—Ä—ã–π': '–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è.'
            };

            people.forEach(person => {
              const tags = Array.isArray(person.tags) ? person.tags : [];
              tags.forEach(tag => {
                if (tagRecommendations[tag]) {
                  results += `<li>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è ${person.name} (${tag}): ${tagRecommendations[tag]}</li>`;
                }
              });
            });

            // –í–ª–∏—è–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            results += `<li>–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${state === 'fatigue' ? '–û—Ç–¥–æ—Ö–Ω–∏—Ç–µ' : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ'}</li>`;

            // –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            const last30Days = new Date(now - 30 * 24 * 60 * 60 * 1000);
            const recentTransactions = transactions.filter(t => new Date(t.date) >= last30Days);
            const income = recentTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = recentTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const total = income + expense;
            const percentage = total ? (income / total * 100).toFixed(2) : 0;
            results += `<li>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${percentage}% (${percentage > 50 ? '–•–æ—Ä–æ—à–æ' : '–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è'})</li>`;

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º
            const strategies = JSON.parse(localStorage.getItem('strategies') || '[]');
            if (strategies.length > 0) {
              results += `<li>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ${strategies.map(s => s.goal).join(', ')}. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä—ã—á–∞–≥–∏ –≤–ª–∏—è–Ω–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ —Ä–µ—Å—É—Ä—Å—ã.</li>`;
            } else {
              results += '<li>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π. –î–æ–±–∞–≤—å—Ç–µ —Ü–µ–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏.</li>';
            }

            results += '</ul>';
            analyticsResults.innerHTML = results;
            logActivity('–û–±–Ω–æ–≤–ª–µ–Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞');
            showError('analytics', '');
          } catch (e) {
            showError('analytics', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É: ' + e.message);
          }
        };

        window.renderAnalytics();
        console.log('–¢–µ–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
      } catch (e) {
        showError('analytics', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    function initReminders() {
      try {
        const reminderText = document.getElementById('reminder-text');
        const reminderList = document.getElementById('reminder-list');
        let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');

        const renderReminders = () => {
          try {
            reminderList.innerHTML = '';
            tasks.forEach((task, index) => {
              const li = document.createElement('li');
              li.innerHTML = `
                ${task.text} (${new Date(task.created).toLocaleDateString()})
                <button onclick="deleteReminder(${index})">‚ùå</button>
              `;
              reminderList.appendChild(li);
            });
            window.renderAnalytics();
            showError('reminders', '');
          } catch (e) {
            showError('reminders', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: ' + e.message);
          }
        };

        window.addReminder = () => {
          try {
            const text = reminderText.value.trim();
            if (text) {
              tasks.push({ text, created: new Date().toISOString(), completed: false });
              localStorage.setItem('tasks', JSON.stringify(tasks));
              reminderText.value = '';
              renderReminders();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${text}`);
              showError('reminders', '');
            } else {
              showError('reminders', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è');
            }
          } catch (e) {
            showError('reminders', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ' + e.message);
          }
        };

        window.deleteReminder = (index) => {
          try {
            const text = tasks[index].text;
            tasks.splice(index, 1);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            renderReminders();
            logActivity(`–£–¥–∞–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${text}`);
            showError('reminders', '');
          } catch (e) {
            showError('reminders', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ' + e.message);
          }
        };

        renderReminders();
        console.log('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
      } catch (e) {
        showError('reminders', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
    document.addEventListener('DOMContentLoaded', () => {
      initEnvironment();
      initFitness();
      initFinance();
      initArchetype();
      initStrategy();
      initAnalytics();
      initReminders();

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then(() => console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
          .catch(err => console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', err));
      }
    });
  </script>
</body>
</html>