<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BlackTrigger HQ</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a1a">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #1a1a1a; color: #e0e0e0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; background-size: cover; }
    .nav-bar {
      display: flex; flex-wrap: wrap; justify-content: space-around; background: #222; padding: 10px;
      margin-bottom: 20px; border-radius: 5px;
    }
    .module {
      border: 1px solid #444; margin: 10px 0; border-radius: 5px;
    }
    .module-header {
      padding: 10px; background: #333; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .module-content { padding: 10px; display: none; }
    .module.always-open .module-content { display: block; }
    .module:not(.collapsed) .module-content { display: block; }
    .error { color: #ff5555; margin: 10px 0; }
    .strategy-tree { display: flex; flex-direction: column; align-items: stretch; }
    .strategy-node { padding: 10px; border: 1px solid #444; margin: 5px; border-radius: 5px; }
    .strategy-branch { margin-left: 20px; }
    .profile-card { padding: 10px; border: 1px solid #444; margin: 5px; cursor: pointer; }
    .profile-details { display: none; }
    .profile-card.expanded .profile-details { display: block; }
    .finance-container { display: flex; flex-direction: column; gap: 10px; }
    .rule-actions { display: flex; justify-content: space-between; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
    .modal-content { background: #333; padding: 20px; margin: 10% auto; width: 80%; max-width: 600px; border-radius: 5px; }
    .modal.show { display: block; }
    .critical-notification { display: none; color: #ff5555; padding: 10px; border: 1px solid #ff5555; margin: 10px 0; }
    /* Настройка размеров */
    .button-small { padding: 8px 16px; font-size: 14px; }
    .button-medium { padding: 12px 20px; font-size: 16px; }
    .button-large { padding: 16px 24px; font-size: 18px; }
    .module-small { max-width: 300px; }
    .module-medium { max-width: 400px; }
    .module-large { max-width: 500px; }
    button { background: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    select, input[type="text"], input[type="number"], input[type="file"], textarea {
      background: #333; color: #e0e0e0; border: 1px solid #444; padding: 5px; border-radius: 5px;
    }
    /* Режимы */
    .absolute { background: #1a1a1a; --accent: #ff5555; --accent-dark: #cc0000; }
    .recon { background: #1a1a1a; --accent: #55aaff; --accent-dark: #336699; }
    .hunter { background: #1a1a1a; --accent: #55ff55; --accent-dark: #33cc33; }
    button.accent { background: var(--accent); }
    button.accent:hover { background: var(--accent-dark); }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav-bar">
      <button class="accent button-medium" onclick="toggleModule('rule-module')">Правило дня</button>
      <button class="accent button-medium" onclick="toggleModule('plan-module')">План дня</button>
      <button class="accent button-medium" onclick="toggleModule('environment-module')">Окружение</button>
      <button class="accent button-medium" onclick="toggleModule('finance-module')">Финансы</button>
      <button class="accent button-medium" onclick="toggleModule('fitness-module')">Физо</button>
      <button class="accent button-medium" onclick="toggleModule('strategy-module')">Карта стратегии</button>
      <button class="accent button-medium" onclick="toggleModule('habits-module')">Привычки</button>
      <button class="accent button-medium" onclick="toggleModule('notes-module')">Заметки</button>
      <button class="accent button-medium" onclick="toggleModule('knowledge-module')">База знаний</button>
      <button class="accent button-medium" onclick="toggleModule('archetype-module')">Архетипы</button>
      <button class="accent button-medium" onclick="toggleModule('analytics-module')">Аналитика</button>
      <button class="accent button-medium" onclick="toggleModule('settings-module')">Настройки</button>
    </div>
    <div class="critical-notification" id="critical-notification"></div>

    <!-- Правило дня -->
    <div class="module always-open module-medium" id="rule-module">
      <div class="module-header">
        <h2>Правило дня</h2>
      </div>
      <div class="module-content">
        <div id="rule-text"></div>
        <div class="rule-actions">
          <button class="button-medium" onclick="adhereRule()">Придержался</button>
          <button class="button-medium" onclick="violateRule()">Нарушил</button>
        </div>
        <input type="text" id="custom-rule" placeholder="Добавить правило">
        <button class="button-medium" onclick="addCustomRule()">Добавить</button>
        <div class="error" id="rule-error"></div>
      </div>
    </div>

  <!-- План дня -->
    <div class="module always-open module-medium" id="plan-module">
      <div class="module-header">
        <h2>План дня</h2>
      </div>
      <div class="module-content">
        <input type="text" id="plan-text" placeholder="Введите задачу">
        <select id="plan-priority">
          <option value="low">Низкий</option>
          <option value="medium">Средний</option>
          <option value="high">Высокий</option>
        </select>
        <button class="button-medium" onclick="addPlan()">Добавить</button>
        <div class="error" id="plan-error"></div>
        <ul id="plan-list"></ul>
      </div>
    </div>

    <!-- Окружение -->
    <div class="module collapsed module-medium" id="environment-module">
      <div class="module-header" onclick="toggleModule('environment-module')">
        <h2>Окружение</h2>
        <span>▼</span>
      </div>
      <div class="module-content">
        <button class="button-medium" onclick="openPersonModal()">Добавить человека</button>
        <div class="error" id="environment-error"></div>
        <div id="people-list"></div>
        <div id="network-graph"></div>
      </div>
    </div>

    <!-- Финансы -->
    <div class="module collapsed module-medium" id="finance-module">
      <div class="module-header" onclick="toggleModule('finance-module')">
        <h2>Финансы</h2>
        <span>▼</span>
      </div>
      <div class="module-content">
        <div class="finance-container">
          <input type="number" id="finance-amount" placeholder="Сумма">
          <select id="finance-type">
            <option value="income">Доход</option>
            <option value="expense">Расход</option>
          </select>
          <input type="text" id="finance-tag" placeholder="Тег">
          <button class="button-medium" onclick="addTransaction()">Добавить</button>
        </div>
        <div class="error" id="finance-error"></div>
        <canvas id="finance-chart"></canvas>
        <ul id="finance-list"></ul>
      </div>
    </div>

    <!-- Физо -->
    <div class="module collapsed module-medium" id="fitness-module">
      <div class="module-header" onclick="toggleModule('fitness-module')">
        <h2>Физо</h2>
        <span>▼</span>
      </div>
      <div class="module-content">
        <input type="text" id="exercise-type" placeholder="Тип упражнения">
        <input type="number" id="exercise-result" placeholder="Результат">
        <button class="button-medium" onclick="addExercise()">Добавить</button>
        <div class="error" id="fitness-error"></div>
        <canvas id="exercise-chart"></canvas>
        <ul id="exercise-list"></ul>
      </div>
    </div>

    <!-- Карта стратегии -->
    <div class="module collapsed module-medium" id="strategy-module">
      <div class="module-header" onclick="toggleModule('strategy-module')">
        <h2>Карта стратегии</h2>
        <span>▼</span>
      </div>
      <div class="module-content">
        <button class="button-medium" onclick="openStrategyModal()">Добавить стратегию</button>
        <div class="error" id="strategy-error"></div>
        <div id="strategy-list" class="strategy-tree"></div>
      </div>
    </div>

    <!-- Привычки -->
    <div class="module collapsed module-medium" id="habits-module">
      <div class="module-header" onclick="toggleModule('habits-module')">
        <h2>Привычки</h2>
        <span>▼</span>
      </div>
      <div class="module-content">
        <input type="text" id="habit-text" placeholder="Введите привычку">
        <select id="habit-frequency">
          <option value="daily">Ежедневно</option>
          <option value="weekly">Еженедельно</option>
        </select>
        <button class="button-medium" onclick="addHabit()">Добавить</button>
        <div class="error" id="habits-error"></div>
        <ul id="habit-list"></ul>
      </div>
    </div>

    <!-- Заметки -->
    <div class="module collapsed module-medium" id="notes-module">
      <div class="module-header" onclick="toggleModule('notes-module')">
        <h2>Заметки</h2>
        <span>▼</span>
      </div>
      <div class="module-content">
        <input type="text" id="note-text" placeholder="Введите заметку">
        <button class="button-medium" onclick="addNote()">Добавить</button>
        <div class="error" id="notes-error"></div>
        <ul id="note-list"></ul>
      </div>
    </div>

    <!-- База знаний -->
    <div class="module collapsed module-medium" id="knowledge-module">
      <div class="module-header" onclick="toggleModule('knowledge-module')">
        <h2>База знаний</h2>
        <span>▼</span>
      </div>
      <div class="module-content">
        <input type="text" id="knowledge-search" placeholder="Поиск по заголовкам/тегам">
        <button class="button-medium" onclick="openKnowledgeModal()">Добавить заметку</button>
        <div class="error" id="knowledge-error"></div>
        <ul id="knowledge-list"></ul>
      </div>
    </div>

    <!-- Архетипы -->
    <div class="module collapsed module-medium" id="archetype-module">
      <div class="module-header" onclick="toggleModule('archetype-module')">
        <h2>Архетипы</h2>
        <span>▼</span>
      </div>
      <div class="module-content">
        <button class="button-medium" onclick="openArchetypeModal()">Пройти тест</button>
        <div id="archetype-result"></div>
        <div class="error" id="archetype-error"></div>
      </div>
    </div>

 <!-- Теневая аналитика -->
    <div class="module always-open module-medium" id="analytics-module">
      <div class="module-header">
        <h2>Теневая аналитика</h2>
      </div>
      <div class="module-content">
        <div class="error" id="analytics-error"></div>
        <div id="analytics-results"></div>
      </div>
    </div>

    <!-- Настройки -->
    <div class="module collapsed module-medium" id="settings-module">
      <div class="module-header" onclick="toggleModule('settings-module')">
        <h2>Настройки</h2>
        <span>▼</span>
      </div>
      <div class="module-content">
        <div>
          <label>Фоновое изображение:</label>
          <input type="file" id="background-image" accept="image/*">
          <button class="button-medium" onclick="applyBackground()">Применить</button>
        </div>
        <div>
          <label>Размер окон:</label>
          <select id="module-size">
            <option value="small">Маленький (300px)</option>
            <option value="medium">Средний (400px)</option>
            <option value="large">Большой (500px)</option>
          </select>
          <button class="button-medium" onclick="applyModuleSize()">Применить</button>
        </div>
        <div>
          <label>Размер кнопок:</label>
          <select id="button-size">
            <option value="small">Маленький</option>
            <option value="medium">Средний</option>
            <option value="large">Большой</option>
          </select>
          <button class="button-medium" onclick="applyButtonSize()">Применить</button>
        </div>
        <button class="button-medium" onclick="exportData()">Экспорт данных</button>
        <input type="file" id="import-file" accept=".json">
        <button class="button-medium" onclick="importData()">Импорт данных</button>
        <button class="button-medium" onclick="initEruda()">Открыть консоль</button>
        <button class="button-medium" onclick="resetSettings()">Сбросить настройки</button>
        <select id="mode-select">
          <option value="Absolute">Absolute</option>
          <option value="Recon">Recon</option>
          <option value="Hunter">Hunter</option>
        </select>
        <button class="button-medium" onclick="switchMode(document.getElementById('mode-select').value)">Сменить режим</button>
        <div class="error" id="settings-error"></div>
      </div>
    </div>

    <!-- Модальные окна -->
    <template id="person-modal-template">
      <div class="modal-content">
        <h2>Добавить человека</h2>
        <input type="text" id="person-name" placeholder="Имя">
        <select id="person-status">
          <option value="loyal">Лояльный</option>
          <option value="neutral">Нейтрал</option>
          <option value="hostile">Враждебный</option>
          <option value="contract">Контракт</option>
        </select>
        <input type="text" id="person-tags" placeholder="Теги (через запятую)">
        <input type="number" id="person-karma" placeholder="Карма">
        <button class="button-medium" onclick="addPerson()">Добавить</button>
        <button class="button-medium" onclick="closeModal('person-modal')">Закрыть</button>
        <div class="error" id="person-modal-error"></div>
      </div>
    </template>
    <template id="strategy-modal-template">
      <div class="modal-content">
        <h2>Добавить стратегию</h2>
        <input type="text" id="strategy-goal" placeholder="Цель">
        <select id="strategy-people" multiple></select>
        <input type="text" id="strategy-resources" placeholder="Ресурсы">
        <input type="text" id="strategy-levers" placeholder="Рычаги">
        <input type="text" id="strategy-obstacles" placeholder="Препятствия">
        <input type="text" id="strategy-actions" placeholder="Действия">
        <select id="strategy-status">
          <option value="plan">План</option>
          <option value="in-progress">В процессе</option>
          <option value="completed">Завершено</option>
        </select>
        <button class="button-medium" onclick="addStrategy()">Добавить</button>
        <button class="button-medium" onclick="closeModal('strategy-modal')">Закрыть</button>
        <div class="error" id="strategy-modal-error"></div>
      </div>
    </template>
    <template id="knowledge-modal-template">
      <div class="modal-content">
        <h2>Добавить заметку</h2>
        <input type="text" id="knowledge-title" placeholder="Заголовок">
        <textarea id="knowledge-content" placeholder="Содержимое"></textarea>
        <input type="text" id="knowledge-tags" placeholder="Теги (через запятую)">
        <button class="button-medium" onclick="addKnowledge()">Добавить</button>
        <button class="button-medium" onclick="closeModal('knowledge-modal')">Закрыть</button>
        <div class="error" id="knowledge-modal-error"></div>
      </div>
    </template>
    <template id="archetype-modal-template">
      <div class="modal-content">
        <h2>Тест архетипа</h2>
        <div id="archetype-questions"></div>
        <button class="button-medium" onclick="submitArchetype()">Отправить</button>
        <button class="button-medium" onclick="closeModal('archetype-modal')">Закрыть</button>
        <div class="error" id="archetype-modal-error"></div>
      </div>
    </template>
    <template id="role-modal-template">
      <div class="modal-content">
        <h2>Тест роли</h2>
        <div id="role-questions"></div>
        <button class="button-medium" onclick="submitRole()">Отправить</button>
        <button class="button-medium" onclick="closeModal('role-modal')">Закрыть</button>
        <div class="error" id="role-modal-error"></div>
      </div>
    </template>
  </div>
// Уведомления
function scheduleNotifications() {
  try {
    if (!('Notification' in window)) return;
    if (Notification.permission !== 'granted') {
      Notification.requestPermission();
      return;
    }
    const plans = JSON.parse(localStorage.getItem('plans') || '[]');
    const habits = JSON.parse(localStorage.getItem('habits') || '[]');
    const now = new Date();
    plans.forEach(plan => {
      if (!plan.completed && new Date(plan.created).toDateString() === now.toDateString()) {
        new Notification('Напоминание', { body: `Задача "${plan.text}" не выполнена!` });
      }
    });
    habits.forEach(habit => {
      if (!habit.todayCompleted && habit.frequency === 'daily') {
        new Notification('Напоминание', { body: `Не забыть про привычку: ${habit.text}` });
      }
    });
  } catch (e) {
    showError('analytics', 'Ошибка уведомлений: ' + e.message);
  }
}

// Проверка бездействия
function checkInactivity() {
  try {
    const lastActivity = localStorage.getItem('lastActivity') || new Date().toISOString();
    const daysSinceLast = (new Date() - new Date(lastActivity)) / (1000 * 60 * 60 * 24);
    if (daysSinceLast > 3) {
      const notification = document.getElementById('critical-notification');
      notification.style.display = 'block';
      notification.textContent = 'Бездействие более 3 дней! Вернитесь к работе!';
      if (Notification.permission === 'granted') {
        new Notification('Критическое уведомление', { body: 'Бездействие более 3 дней!' });
      }
    }
    localStorage.setItem('lastActivity', new Date().toISOString());
  } catch (e) {
    showError('analytics', 'Ошибка проверки бездействия: ' + e.message);
  }
}

// Правило дня
function initRuleOfDay() {
  try {
    const ruleText = document.getElementById('rule-text');
    const customRuleInput = document.getElementById('custom-rule');
    let currentRule = JSON.parse(localStorage.getItem('currentRule') || '{}');
    let customRules = JSON.parse(localStorage.getItem('customRules') || '[]');
    const defaultRules = [
      'Победа — это система, а не случай.',
      'Ресурсы важнее чувств.',
      'Держи врагов ближе, чем друзей.',
      'Сила в дисциплине.',
      'Контроль над собой — контроль над всем.'
    ];

    const updateRule = () => {
      const today = new Date().toDateString();
      if (currentRule.date !== today) {
        const rule = customRules.length > 0 && Math.random() > 0.5
          ? customRules[Math.floor(Math.random() * customRules.length)]
          : defaultRules[Math.floor(Math.random() * defaultRules.length)];
        currentRule = { text: rule, adhered: 0, violated: 0, date: today };
        localStorage.setItem('currentRule', JSON.stringify(currentRule));
      }
      ruleText.textContent = currentRule.text;
      renderAnalytics();
      showError('rule', '');
    };

    window.addCustomRule = () => {
      try {
        const rule = customRuleInput.value.trim();
        if (rule) {
          customRules.push(rule);
          localStorage.setItem('customRules', JSON.stringify.customRules));
          customRuleInput.value = '';
          updateRule();
          logActivity(`Добавлено правило: ${rule}`);
          showError('rule', '');
        } else {
          showError('rule', 'Введите правило');
        }
      } catch (e) {
        showError('rule', 'Не удалось добавить правило: ' + e.message);
      }
    };

    window.adhereRule = () => {
      try {
        currentRule.adhered = (currentRule.adhered || 0) + 1;
        localStorage.setItem('currentRule', JSON.stringify(currentRule));
        renderAnalytics();
        logActivity(`Правило "${currentRule.text}" соблюдено`);
        showError('rule', '');
      } catch (e) {
        showError('rule', 'Не удалось отметить соблюдение: ' + e.message);
      }
    };

    window.violateRule = () => {
      try {
        currentRule.violated = (currentRule.violated || 0) + 1;
        localStorage.setItem('currentRule', JSON.stringify(currentRule));
        renderAnalytics();
        logActivity(`Правило "${currentRule.text}" нарушено`);
        showError('rule', '');
      } catch (e) {
        showError('rule', 'Не удалось отметить нарушение: ' + e.message);
      }
    };

    updateRule();
  } catch (e) {
    showError('rule', 'Ошибка инициализации: ' + e.message);
  }
}

// План дня
function initPlan() {
  try {
    const planText = document.getElementById('plan-text');
    const planPriority = document.getElementById('plan-priority');
    const planList = document.getElementById('plan-list');
    let plans = JSON.parse(localStorage.getItem('plans') || '[]');

    const renderPlans = () => {
      try {
        planList.innerHTML = '';
        plans.forEach((plan, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            ${plan.text} (Приоритет: ${plan.priority}, ${new Date(plan.created).toLocaleDateString()})
            <input type="checkbox" ${plan.completed ? 'checked' : ''} onchange="togglePlan(${index})">
            <button class="button-medium" onclick="deletePlan(${index})">❌</button>
          `;
          planList.appendChild(li);
        });
        renderAnalytics();
        scheduleNotifications();
        showError('plan', '');
      } catch (e) {
        showError('plan', 'Не удалось отобразить задачи: ' + e.message);
      }
    };

    window.addPlan = () => {
      try {
        const text = planText.value.trim();
        const priority = planPriority.value;
        if (text) {
          plans.push({ text, priority, created: new Date().toISOString(), completed: false });
          localStorage.setItem('plans', JSON.stringify(plans));
          planText.value = '';
          planPriority.value = 'low';
          renderPlans();
          logActivity(`Добавлена задача: ${text}`);
          showError('plan', '');
        } else {
          showError('plan', 'Введите задачу');
        }
      } catch (e) {
        showError('plan', 'Не удалось добавить задачу: ' + e.message);
      }
    };

    window.togglePlan = (index) => {
      try {
        plans[index].completed = !plans[index].completed;
        localStorage.setItem('plans', JSON.stringify(plans));
        renderPlans();
        logActivity(`Задача ${plans[index].text}: ${plans[index].completed ? 'Выполнена' : 'Отменена'}`);
      } catch (e) {
        showError('plan', 'Не удалось изменить статус задачи: ' + e.message);
      }
    };

    window.deletePlan = (index) => {
      try {
        const text = plans[index].text;
        plans.splice(index, 1);
        localStorage.setItem('plans', JSON.stringify(plans));
        renderPlans();
        logActivity(`Удалена задача: ${text}`);
        showError('plan', '');
      } catch (e) {
        showError('plan', 'Не удалось удалить задачу: ' + e.message);
      }
    };

    renderPlans();
  } catch (e) {
    showError('plan', 'Ошибка инициализации: ' + e.message);
  }
}

// Аналитика (заглушка, будет дополнена позже)
function renderAnalytics() {
  try {
    const analyticsResults = document.getElementById('analytics-results');
    const plans = JSON.parse(localStorage.getItem('plans') || '[]');
    const completedPlans = plans.filter(p => p.completed).length;
    const totalPlans = plans.length;
    const rule = JSON.parse(localStorage.getItem('currentRule') || '{}');
    analyticsResults.innerHTML = `
      <p>Задачи: ${completedPlans}/${totalPlans} (${totalPlans ? Math.round((completedPlans / totalPlans) * 100) : 0}% выполнено)</p>
      <p>Правило дня: Соблюдено ${rule.adhered || 0}, Нарушено ${rule.violated || 0}</p>
    `;
    showError('analytics', '');
  } catch (e) {
    showError('analytics', 'Ошибка аналитики: ' + e.message);
  }
}

// Инициализация Eruda
function initEruda() {
  try {
    eruda.init();
    logActivity('Консоль Eruda открыта');
  } catch (e) {
    showError('settings', 'Ошибка открытия консоли: ' + e.message);
  }
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', () => {
  try {
    const mode = localStorage.getItem('mode') || 'Absolute';
    switchMode(mode);
    document.getElementById('mode-select').value = mode;
    const customSettings = JSON.parse(localStorage.getItem('customSettings') || '{}');
    if (customSettings.backgroundImage) {
      document.querySelector('.container').style.backgroundImage = `url(${customSettings.backgroundImage})`;
    }
    if (customSettings.moduleSize) {
      document.querySelectorAll('.module').forEach(module => {
        module.classList.add(`module-${customSettings.moduleSize}`);
      });
      document.getElementById('module-size').value = customSettings.moduleSize;
    }
    if (customSettings.buttonSize) {
      document.querySelectorAll('button').forEach(button => {
        button.classList.add(`button-${customSettings.buttonSize}`);
      });
      document.getElementById('button-size').value = customSettings.buttonSize;
    }
    initRuleOfDay();
    initPlan();
    checkInactivity();
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
        .then(reg => {
          console.log('Service Worker зарегистрирован:', reg);
          logActivity('Service Worker зарегистрирован');
        })
        .catch(err => {
          console.error('Ошибка регистрации Service Worker:', err);
          showError('settings', 'Ошибка Service Worker: ' + err.message);
        });
    }
  } catch (e) {
    showError('settings', 'Ошибка инициализации приложения: ' + e.message);
  }
});

  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>
    // Общие функции
    function toggleModule(moduleId) {
      const module = document.getElementById(moduleId);
      if (!module.classList.contains('always-open')) {
        module.classList.toggle('collapsed');
      }
    }

    function showError(moduleId, message) {
      const errorElement = document.getElementById(`${moduleId}-error`);
      if (errorElement) errorElement.textContent = message;
    }

    function logActivity(message) {
      let activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
      activityLog.push({ message, timestamp: new Date().toISOString() });
      if (activityLog.length > 50) activityLog.shift();
      localStorage.setItem('activityLog', JSON.stringify(activityLog));
    }

    function openModal(templateId, modalId) {
      const modal = document.createElement('div');
      modal.id = modalId;
      modal.className = 'modal';
      modal.innerHTML = document.getElementById(templateId).innerHTML;
      document.body.appendChild(modal);
      modal.classList.add('show');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
    }

    function exportData() {
      try {
        const data = {
          rule: localStorage.getItem('currentRule'),
          customRules: localStorage.getItem('customRules'),
          plans: localStorage.getItem('plans'),
          people: localStorage.getItem('people'),
          transactions: localStorage.getItem('transactions'),
          exercises: localStorage.getItem('exercises'),
          strategies: localStorage.getItem('strategies'),
          habits: localStorage.getItem('habits'),
          notes: localStorage.getItem('notes'),
          knowledge: localStorage.getItem('knowledge'),
          archetype: localStorage.getItem('archetype'),
          customSettings: localStorage.getItem('customSettings')
        };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'blacktrigger-data.json';
        a.click();
        URL.revokeObjectURL(url);
        logActivity('Данные экспортированы');
      } catch (e) {
        showError('settings', 'Ошибка экспорта: ' + e.message);
      }
    }

    function importData() {
      try {
        const fileInput = document.getElementById('import-file');
        if (fileInput.files.length === 0) {
          showError('settings', 'Выберите файл');
          return;
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = JSON.parse(e.target.result);
          for (const key in data) {
            if (data[key]) localStorage.setItem(key, data[key]);
          }
          location.reload();
          logActivity('Данные импортированы');
        };
        reader.readAsText(file);
      } catch (e) {
        showError('settings', 'Ошибка импорта: ' + e.message);
      }
    }

    function switchMode(mode) {
      document.body.className = mode.toLowerCase();
      localStorage.setItem('mode', mode);
      logActivity(`Режим изменён на ${mode}`);
    }

    function applyBackground() {
      try {
        const fileInput = document.getElementById('background-image');
        if (fileInput.files.length === 0) {
          showError('settings', 'Выберите изображение');
          return;
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          const customSettings = JSON.parse(localStorage.getItem('customSettings') || '{}');
          customSettings.backgroundImage = e.target.result;
          localStorage.setItem('customSettings', JSON.stringify(customSettings));
          document.querySelector('.container').style.backgroundImage = `url(${customSettings.backgroundImage})`;
          logActivity('Фоновое изображение изменено');
        };
        reader.readAsDataURL(file);
      } catch (e) {
        showError('settings', 'Ошибка загрузки фона: ' + e.message);
      }
    }

    function applyModuleSize() {
      try {
        const size = document.getElementById('module-size').value;
        const customSettings = JSON.parse(localStorage.getItem('customSettings') || '{}');
        customSettings.moduleSize = size;
        localStorage.setItem('customSettings', JSON.stringify(customSettings));
        document.querySelectorAll('.module').forEach(module => {
          module.classList.remove('module-small', 'module-medium', 'module-large');
          module.classList.add(`module-${size}`);
        });
        logActivity(`Размер окон изменён на ${size}`);
      } catch (e) {
        showError('settings', 'Ошибка изменения размера окон: ' + e.message);
      }
    }


function applyButtonSize() {
      try {
        const size = document.getElementById('button-size').value;
        const customSettings = JSON.parse(localStorage.getItem('customSettings') || '{}');
        customSettings.buttonSize = size;
        localStorage.setItem('customSettings', JSON.stringify(customSettings));
        document.querySelectorAll('button').forEach(button => {
          button.classList.remove('button-small', 'button-medium', 'button-large');
          button.classList.add(`button-${size}`);
        });
        logActivity(`Размер кнопок изменён на ${size}`);
      } catch (e) {
        showError('settings', 'Ошибка изменения размера кнопок: ' + e.message);
      }
    }

    function resetSettings() {
      try {
        localStorage.removeItem('customSettings');
        document.querySelector('.container').style.backgroundImage = '';
        document.querySelectorAll('.module').forEach(module => {
          module.classList.remove('module-small', 'module-medium', 'module-large');
          module.classList.add('module-medium');
        });
        document.querySelectorAll('button').forEach(button => {
          button.classList.remove('button-small', 'button-medium', 'button-large');
          button.classList.add('button-medium');
        });
        logActivity('Настройки сброшены');
      } catch (e) {
        showError('settings', 'Ошибка сброса настроек: ' + e.message);
      }
    }
  </script>
</body>
</html>