<!-- –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π HTML —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –∏ –º–æ–¥—É–ª—è–º–∏ -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BlackTrigger HQ</title>
  <link rel="manifest" href="/manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #1a1a1a;
      color: #e0e0e0;
      font-size: 16px;
    }
    .nav-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .nav-button {
      padding: 12px 20px;
      background: #007bff;
      border: none;
      border-radius: 5px;
      color: #e0e0e0;
      font-size: 1.1em;
      cursor: pointer;
      flex: 1;
      min-width: 100px;
      max-width: 150px;
    }
    .nav-button:hover { background: #0056b3; }
    .module {
      margin-bottom: 15px;
      padding: 10px;
      background: #2a2a2a;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .module.collapsed .module-content { display: none; }
    .module-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h2 { margin: 0 0 10px; color: #00b7ff; font-size: 1.2em; }
    input, select, button {
      padding: 10px;
      margin: 5px;
      border-radius: 3px;
      border: 1px solid #444;
      background: #333;
      color: #e0e0e0;
      font-size: 1em;
      width: calc(100% - 22px);
      box-sizing: border-box;
    }
    button { background: #007bff; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    ul { list-style: none; padding: 0; }
    li { padding: 8px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
    .error { color: #ff4444; font-size: 0.9em; }
    .profile-card { padding: 8px; border: 1px solid #444; margin-bottom: 5px; cursor: pointer; }
    .profile-details { display: none; padding: 10px; }
    .profile-details.active { display: block; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: #2a2a2a; padding: 15px; border-radius: 5px; max-width: 90%; max-height: 80%; overflow-y: auto; color: #e0e0e0; }
    .modal.active { display: flex; }
    canvas { max-width: 100%; background: #2a2a2a; padding: 10px; border-radius: 5px; }
    .finance-container { display: flex; flex-direction: column; }
    .strategy-tree { display: flex; flex-direction: column; align-items: stretch; }
    .strategy-node { padding: 10px; border: 1px solid #444; margin: 5px; border-radius: 5px; width: 100%; }
    .strategy-branch { margin-left: 20px; }
    #network { height: 150px; border: 1px solid #444; border-radius: 5px; }
    #rule-of-day { font-size: 1.1em; font-weight: bold; color: #00ff00; }
    .rule-actions { display: flex; justify-content: space-between; }
    .critical-notification { background: #ff4444; padding: 10px; font-weight: bold; margin-bottom: 10px; }
    .mode-switch { margin-bottom: 10px; }
    .mode-switch button { margin-right: 5px; }
    .settings-module { margin-top: 20px; }
    .knowledge-list div { cursor: pointer; padding: 10px; border-bottom: 1px solid #444; }
    .knowledge-list div:hover { background: #333; }
    .knowledge-tags { font-size: 0.9em; color: #888; }
  </style>
</head>
<body>
  <div class="nav-bar">
    <button class="nav-button" onclick="toggleModule('rule-module')">–ü—Ä–∞–≤–∏–ª–æ –¥–Ω—è</button>
    <button class="nav-button" onclick="toggleModule('plan-module')">–ü–ª–∞–Ω –¥–Ω—è</button>
    <button class="nav-button" onclick="toggleModule('environment-module')">–û–∫—Ä—É–∂–µ–Ω–∏–µ</button>
    <button class="nav-button" onclick="toggleModule('finance-module')">–§–∏–Ω–∞–Ω—Å—ã</button>
    <button class="nav-button" onclick="toggleModule('fitness-module')">–§–∏–∑–æ</button>
    <button class="nav-button" onclick="toggleModule('strategy-module')">–°—Ç—Ä–∞—Ç–µ–≥–∏–∏</button>
    <button class="nav-button" onclick="toggleModule('habits-module')">–ü—Ä–∏–≤—ã—á–∫–∏</button>
    <button class="nav-button" onclick="toggleModule('notes-module')">–ó–∞–º–µ—Ç–∫–∏</button>
    <button class="nav-button" onclick="toggleModule('knowledge-module')">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</button>
    <button class="nav-button" onclick="toggleModule('settings-module')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>

  <div class="module" id="notification-module">
    <div id="critical-notification" class="critical-notification" style="display: none;"></div>
  </div>

  <div class="module" id="rule-module">
    <div class="module-header" onclick="toggleModule('rule-module')">
      <h2>–ü—Ä–∞–≤–∏–ª–æ –¥–Ω—è</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <div id="rule-of-day"></div>
      <div class="rule-actions">
        <button onclick="markRule('adhered')">–ü—Ä–∏–¥–µ—Ä–∂–∞–ª—Å—è</button>
        <button onclick="markRule('violated')">–ù–∞—Ä—É—à–∏–ª</button>
      </div>
      <input type="text" id="custom-rule" placeholder="–°–≤–æ—ë –ø—Ä–∞–≤–∏–ª–æ">
      <button onclick="addCustomRule()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
      <div class="error" id="rule-error"></div>
    </div>
  </div>

  <div class="module" id="plan-module">
    <div class="module-header" onclick="toggleModule('plan-module')">
      <h2>–ü–ª–∞–Ω –¥–Ω—è</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <input type="text" id="plan-text" placeholder="–ó–∞–¥–∞—á–∞">
      <select id="plan-priority">
        <option value="low">–ù–∏–∑–∫–∏–π</option>
        <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
        <option value="high">–í—ã—Å–æ–∫–∏–π</option>
      </select>
      <button onclick="addPlan()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <ul id="plan-list"></ul>
      <div class="error" id="plan-error"></div>
    </div>
  </div>

  <div class="module collapsed" id="environment-module">
    <div class="module-header" onclick="toggleModule('environment-module')">
      <h2>–û–∫—Ä—É–∂–µ–Ω–∏–µ</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <input type="text" id="person-name" placeholder="–ò–º—è —á–µ–ª–æ–≤–µ–∫–∞">
      <select id="person-status">
        <option value="loyal">–õ–æ—è–ª—å–Ω—ã–π</option>
        <option value="neutral">–ù–µ–π—Ç—Ä–∞–ª</option>
        <option value="hostile">–í—Ä–∞–∂–¥–µ–±–Ω—ã–π</option>
        <option value="contract">–ö–æ–Ω—Ç—Ä–∞–∫—Ç</option>
      </select>
      <select id="person-tags" multiple>
        <option value="üí∞ –†–µ—Å—É—Ä—Å">üí∞ –†–µ—Å—É—Ä—Å</option>
        <option value="ü™® –ë–∞–ª–ª–∞—Å—Ç">ü™® –ë–∞–ª–ª–∞—Å—Ç</option>
        <option value="üó£Ô∏è –ë–æ–ª—Ç—É–Ω">üó£Ô∏è –ë–æ–ª—Ç—É–Ω</option>
        <option value="üß© –ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä">üß© –ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä</option>
        <option value="üëë –õ–∏–¥–µ—Ä">üëë –õ–∏–¥–µ—Ä</option>
        <option value="ü§ù –°–æ—é–∑–Ω–∏–∫">ü§ù –°–æ—é–∑–Ω–∏–∫</option>
        <option value="‚öîÔ∏è –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç">‚öîÔ∏è –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç</option>
        <option value="üíº –ü–∞—Ä—Ç–Ω—ë—Ä">üíº –ü–∞—Ä—Ç–Ω—ë—Ä</option>
        <option value="‚ú® –ò—Å–∫—Ä—ã">‚ú® –ò—Å–∫—Ä—ã</option>
        <option value="üåë –¢–µ–Ω—å">üåë –¢–µ–Ω—å</option>
        <option value="üß† –ú–µ–Ω—Ç–æ—Ä">üß† –ú–µ–Ω—Ç–æ—Ä</option>
        <option value="‚öôÔ∏è –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å">‚öôÔ∏è –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</option>
      </select>
      <input type="number" id="person-karma" placeholder="–ö–∞—Ä–º–∞ (0)" value="0">
      <select id="person-connections" multiple>
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤—è–∑–∏</option>
      </select>
      <input type="text" id="connection-type" placeholder="–¢–∏–ø —Å–≤—è–∑–∏ (–¥–æ–≤–µ—Ä–∏–µ, –∫–æ–Ω—Ñ–ª–∏–∫—Ç)">
      <button onclick="addPerson()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <div class="error" id="environment-error"></div>
      <ul id="person-list"></ul>
      <div id="network"></div>
    </div>
  </div>

  <div class="module collapsed" id="finance-module">
    <div class="module-header" onclick="toggleModule('finance-module')">
      <h2>–§–∏–Ω–∞–Ω—Å—ã</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <div class="finance-container">
        <div>
          <h3>–î–æ—Ö–æ–¥—ã</h3>
          <input type="number" id="income-amount" placeholder="–°—É–º–º–∞">
          <select id="income-tag">
            <option value="–ó–∞—Ä–ø–ª–∞—Ç–∞">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
            <option value="–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</option>
            <option value="–§—Ä–∏–ª–∞–Ω—Å">–§—Ä–∏–ª–∞–Ω—Å</option>
            <option value="–ü—Ä–æ—á–µ–µ">–ü—Ä–æ—á–µ–µ</option>
          </select>
          <button onclick="toggleCustomTag('income')">–í–≤–µ—Å—Ç–∏ —Å–≤–æ–π —Ç–µ–≥</button>
          <input type="text" id="income-custom-tag" class="collapsible" placeholder="–°–≤–æ–π —Ç–µ–≥">
          <button class="collapsible" id="save-income-custom-tag" onclick="saveCustomTag('income')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–≥</button>
          <button onclick="addTransaction('income')">–ó–∞–ø–∏—Å–∞—Ç—å</button>
          <ul id="income-list"></ul>
        </div>
        <div>
          <h3>–†–∞—Å—Ö–æ–¥—ã</h3>
          <input type="number" id="expense-amount" placeholder="–°—É–º–º–∞">
          <select id="expense-tag">
            <option value="–ï–¥–∞">–ï–¥–∞</option>
            <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
            <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
            <option value="–ñ–∏–ª—å—ë">–ñ–∏–ª—å—ë</option>
            <option value="–ü—Ä–æ—á–µ–µ">–ü—Ä–æ—á–µ–µ</option>
          </select>
          <button onclick="toggleCustomTag('expense')">–í–≤–µ—Å—Ç–∏ —Å–≤–æ–π —Ç–µ–≥</button>
          <input type="text" id="expense-custom-tag" class="collapsible" placeholder="–°–≤–æ–π —Ç–µ–≥">
          <button class="collapsible" id="save-expense-custom-tag" onclick="saveCustomTag('expense')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–≥</button>
          <button onclick="addTransaction('expense')">–ó–∞–ø–∏—Å–∞—Ç—å</button>
          <ul id="expense-list"></ul>
        </div>
      </div>
      <div id="finance-percentage"></div>
      <canvas id="finance-chart"></canvas>
      <div id="finance-advice"></div>
      <div class="error" id="finance-error"></div>
    </div>
  </div>

  <div class="module collapsed" id="fitness-module">
    <div class="module-header" onclick="toggleModule('fitness-module')">
      <h2>–§–∏–∑–æ</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <input type="text" id="exercise-type" placeholder="–¢–∏–ø (–Ω–∞–ø—Ä., –û—Ç–∂–∏–º–∞–Ω–∏—è)">
      <input type="number" id="exercise-result" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–∞–ø—Ä., 20)">
      <button onclick="addExercise()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
      <ul id="exercise-list"></ul>
      <div class="error" id="fitness-error"></div>
      <canvas id="fitness-chart"></canvas>
    </div>
  </div>

  <div class="module collapsed" id="strategy-module">
    <div class="module-header" onclick="toggleModule('strategy-module')">
      <h2>–ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <button onclick="openStrategyModal()">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é</button>
      <div class="error" id="strategy-error"></div>
      <div id="strategy-list" class="strategy-tree"></div>
    </div>
  </div>

  <div class="module collapsed" id="habits-module">
    <div class="module-header" onclick="toggleModule('habits-module')">
      <h2>–ü—Ä–∏–≤—ã—á–∫–∏</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <input type="text" id="habit-text" placeholder="–ü—Ä–∏–≤—ã—á–∫–∞ (–Ω–∞–ø—Ä., –ß–∏—Ç–∞—Ç—å 10 —Å—Ç—Ä–∞–Ω–∏—Ü)">
      <select id="habit-frequency">
        <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
        <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
      </select>
      <button onclick="addHabit()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <div class="error" id="habits-error"></div>
      <ul id="habit-list"></ul>
    </div>
  </div>

  <div class="module collapsed" id="notes-module">
    <div class="module-header" onclick="toggleModule('notes-module')">
      <h2>–ó–∞–º–µ—Ç–∫–∏</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <input type="text" id="note-text" placeholder="–ë—ã—Å—Ç—Ä–∞—è –∑–∞–º–µ—Ç–∫–∞">
      <button onclick="addNote()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <div class="error" id="notes-error"></div>
      <ul id="note-list"></ul>
    </div>
  </div>

  <div class="module collapsed" id="archetype-module">
    <div class="module-header" onclick="toggleModule('archetype-module')">
      <h2>–ê—Ä—Ö–µ—Ç–∏–ø—ã</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <div id="archetype-result"></div>
      <button onclick="openArchetypeModal()">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>
      <div class="error" id="archetype-error"></div>
    </div>
  </div>

  <div class="module collapsed" id="analytics-module">
    <div class="module-header" onclick="toggleModule('analytics-module')">
      <h2>–¢–µ–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <button onclick="renderAnalytics()">–û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É</button>
      <div id="analytics-results"></div>
      <div class="error" id="analytics-error"></div>
    </div>
  </div>

  <div class="module collapsed" id="knowledge-module">
    <div class="module-header" onclick="toggleModule('knowledge-module')">
      <h2>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (Zettelkasten)</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <input type="text" id="knowledge-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ">
      <input type="text" id="knowledge-tags" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
      <div id="knowledge-list" class="knowledge-list"></div>
      <button onclick="openKnowledgeModal()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
      <div class="error" id="knowledge-error"></div>
    </div>
  </div>

  <div class="module collapsed" id="settings-module">
    <div class="module-header" onclick="toggleModule('settings-module')">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <span>‚ñº</span>
    </div>
    <div class="module-content">
      <button onclick="initEruda()">–û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å</button>
      <button onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
      <input type="file" id="import-data" accept=".json" onchange="importData()">
      <div class="error" id="settings-error"></div>
    </div>
  </div>

  <template id="archetype-modal-template">
    <div class="modal" id="archetype-modal">
      <div class="modal-content">
        <h2>–¢–µ—Å—Ç –Ω–∞ –∞—Ä—Ö–µ—Ç–∏–ø</h2>
        <div id="questions"></div>
        <button onclick="submitArchetype()">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button>
        <button onclick="closeModal('archetype-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div class="error" id="archetype-modal-error"></div>
      </div>
    </div>
  </template>

  <template id="strategy-modal-template">
    <div class="modal" id="strategy-modal">
      <div class="modal-content">
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é</h2>
        <input type="text" id="strategy-goal" placeholder="–¶–µ–ª—å">
        <select id="strategy-people" multiple>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞</option>
        </select>
        <input type="text" id="strategy-resources" placeholder="–†–µ—Å—É—Ä—Å—ã">
        <input type="text" id="strategy-levers" placeholder="–†—ã—á–∞–≥–∏">
        <input type="text" id="strategy-obstacles" placeholder="–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è">
        <input type="text" id="strategy-actions" placeholder="–î–µ–π—Å—Ç–≤–∏—è">
        <select id="strategy-status">
          <option value="plan">–ü–ª–∞–Ω</option>
          <option value="in-progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
          <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
        </select>
        <button onclick="addStrategy()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="closeModal('strategy-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div class="error" id="strategy-modal-error"></div>
      </div>
    </div>
  </template>

  <template id="knowledge-modal-template">
    <div class="modal" id="knowledge-modal">
      <div class="modal-content">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</h2>
        <input type="text" id="knowledge-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏">
        <textarea id="knowledge-content" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏"></textarea>
        <input type="text" id="knowledge-tags-input" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
        <button onclick="addKnowledge()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="closeModal('knowledge-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div class="error" id="knowledge-modal-error"></div>
      </div>
    </div>
  </template>

  <script>
    // –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function toggleModule(moduleId) {
      const module = document.getElementById(moduleId);
      module.classList.toggle('collapsed');
      module.querySelector('.module-header span').textContent = module.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    }

    function showError(module, message) {
      const errorDiv = document.getElementById(`${module}-error`);
      if (errorDiv) errorDiv.textContent = message;
    }

    function logActivity(message) {
      let log = JSON.parse(localStorage.getItem('activityLog') || '[]');
      let undoLog = JSON.parse(localStorage.getItem('undoLog') || '[]');
      const timestamp = new Date().toLocaleString();
      log.push({ timestamp, message });
      undoLog.push({ timestamp, message });
      if (undoLog.length > 5) undoLog.shift();
      localStorage.setItem('activityLog', JSON.stringify(log));
      localStorage.setItem('undoLog', JSON.stringify(undoLog));
    }

    function undoAction() {
      let undoLog = JSON.parse(localStorage.getItem('undoLog') || '[]');
      if (undoLog.length > 0) {
        undoLog.pop();
        localStorage.setItem('undoLog', JSON.stringify(undoLog));
        logActivity('–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ');
        renderAnalytics();
      }
    }

    function openModal(templateId, modalId, dataset = {}) {
      const template = document.getElementById(templateId);
      const modal = template.content.cloneNode(true).querySelector('.modal');
      modal.id = modalId;
      Object.assign(modal.dataset, dataset);
      document.body.appendChild(modal);
      modal.classList.add('active');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
    }

    function switchMode(mode) {
      const style = document.body.style;
      style.background = mode === 'Absolute' ? '#1a1a1a' : mode === 'Recon' ? '#1a2a3a' : '#1a3a1a';
      document.querySelectorAll('h2').forEach(h2 => {
        h2.style.color = mode === 'Absolute' ? '#ff4444' : mode === 'Recon' ? '#00b7ff' : '#00ff00';
      });
      document.querySelectorAll('.nav-button').forEach(btn => {
        btn.style.background = mode === 'Absolute' ? '#ff4444' : mode === 'Recon' ? '#00b7ff' : '#00ff00';
      });
      localStorage.setItem('mode', mode);
      logActivity(`–†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω: ${mode}`);
    }

    function exportData() {
      const data = {
        people: JSON.parse(localStorage.getItem('people') || '[]'),
        transactions: JSON.parse(localStorage.getItem('transactions') || '[]'),
        plans: JSON.parse(localStorage.getItem('plans') || '[]'),
        strategies: JSON.parse(localStorage.getItem('strategies') || '[]'),
        exercises: JSON.parse(localStorage.getItem('exercises') || '[]'),
        habits: JSON.parse(localStorage.getItem('habits') || '[]'),
        notes: JSON.parse(localStorage.getItem('notes') || '[]'),
        knowledge: JSON.parse(localStorage.getItem('knowledge') || '[]'),
        customRules: JSON.parse(localStorage.getItem('customRules') || '[]'),
        customIncomeTags: JSON.parse(localStorage.getItem('customIncomeTags') || '[]'),
        customExpenseTags: JSON.parse(localStorage.getItem('customExpenseTags') || '[]')
      };
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'blacktrigger_data.json';
      a.click();
      URL.revokeObjectURL(url);
      logActivity('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
    }

    function importData() {
      const file = document.getElementById('import-data').files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = JSON.parse(e.target.result);
        Object.keys(data).forEach(key => localStorage.setItem(key, JSON.stringify(data[key])));
        window.location.reload();
      };
      reader.readAsText(file);
      logActivity('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
    }

// –ü—Ä–∞–≤–∏–ª–∞ –¥–Ω—è
    const coreRules = [
      "–ï—Å–ª–∏ –Ω–µ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Ä–µ—Å—É—Ä—Å ‚Äî –æ—Ç—Å–µ–∫–∞–π.",
      "–•–∏—â–Ω–∏–∫ –º–æ–ª—á–∏—Ç —á–∞—â–µ, —á–µ–º –≥–æ–≤–æ—Ä–∏—Ç.",
      "–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–æ–±–æ–π ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –≤—Å–µ–º.",
      "–ö–∞–∂–¥–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ ‚Äî –≤–æ–π–Ω–∞ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å—ã.",
      "–ì—Ä—É–±–æ—Å—Ç—å ‚Äî —Ñ–∏–ª—å—Ç—Ä. –ö—Ç–æ —Å–ª–∞–± ‚Äî –æ—Ç–ø–∞–¥—ë—Ç —Å–∞–º.",
      "–°–Ω–∞—á–∞–ª–∞ –¥–æ–º–∏–Ω–∏—Ä—É–π, –ø–æ—Ç–æ–º –¥—Ä—É–∂–∏.",
      "–ï—Å–ª–∏ –Ω–µ –¥–∞–≤—è—Ç –Ω–∞ —Ç–µ–±—è ‚Äî –¥–∞–≤–∏ —Ç—ã.",
      "–õ–æ–∂—å ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å.",
      "–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ ‚â† –≤—ã–≥–æ–¥–Ω–æ–µ. –í—ã–±–∏—Ä–∞–π –≤—ã–≥–æ–¥—É.",
      "–ö–∞–∂–¥—ã–π —à–∞–≥ ‚Äî —ç—Ç–æ —à–∞–≥ –∫ –≤–ª–∞—Å—Ç–∏."
    ];

    function initRuleOfDay() {
      try {
        const ruleDisplay = document.getElementById('rule-of-day');
        const lastRuleDate = localStorage.getItem('ruleDate');
        const today = new Date().toDateString();
        let currentRule = JSON.parse(localStorage.getItem('currentRule') || '{}');
        let customRules = JSON.parse(localStorage.getItem('customRules') || '[]');
        const allRules = [...coreRules, ...customRules];

        if (lastRuleDate !== today || !currentRule.text) {
          currentRule = { text: allRules[Math.floor(Math.random() * allRules.length)], adhered: 0, violated: 0 };
          localStorage.setItem('currentRule', JSON.stringify(currentRule));
          localStorage.setItem('ruleDate', today);
        }

        ruleDisplay.textContent = currentRule.text;
        logActivity(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –¥–Ω—è: ${currentRule.text}`);
        showError('rule', '');
      } catch (e) {
        showError('rule', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    function markRule(status) {
      try {
        let currentRule = JSON.parse(localStorage.getItem('currentRule') || '{}');
        currentRule[status] = (currentRule[status] || 0) + 1;
        localStorage.setItem('currentRule', JSON.stringify(currentRule));
        logActivity(`–ü—Ä–∞–≤–∏–ª–æ –¥–Ω—è: ${status === 'adhered' ? '–ü—Ä–∏–¥–µ—Ä–∂–∞–ª—Å—è' : '–ù–∞—Ä—É—à–∏–ª'} - ${currentRule.text}`);
        renderAnalytics();
        showError('rule', '');
      } catch (e) {
        showError('rule', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ: ' + e.message);
      }
    }

    function addCustomRule() {
      try {
        const customRule = document.getElementById('custom-rule').value.trim();
        if (customRule) {
          let customRules = JSON.parse(localStorage.getItem('customRules') || '[]');
          customRules.push(customRule);
          localStorage.setItem('customRules', JSON.stringify(customRules));
          document.getElementById('custom-rule').value = '';
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ: ${customRule}`);
          initRuleOfDay();
          showError('rule', '');
        } else {
          showError('rule', '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–æ');
        }
      } catch (e) {
        showError('rule', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ: ' + e.message);
      }
    }

    // –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (Zettelkasten)
    function initKnowledge() {
      try {
        const knowledgeList = document.getElementById('knowledge-list');
        const searchInput = document.getElementById('knowledge-search');
        let knowledge = JSON.parse(localStorage.getItem('knowledge') || '[]');
        const defaultKnowledge = [
          { title: "–ö–∞–∫ –Ω–∞–π—Ç–∏ —Ä—ã—á–∞–≥–∏ –≤–ª–∏—è–Ω–∏—è", content: "–ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–π —Å–ª–∞–±–æ—Å—Ç–∏ –¥—Ä—É–≥–∏—Ö, –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö –∞–º–±–∏—Ü–∏–∏, —Å–æ–∑–¥–∞–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å.", tags: ["–≤–ª–∏—è–Ω–∏–µ", "–º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è"] },
          { title: "–¢–µ—Ö–Ω–∏–∫–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏", content: "–î–∞–π –∏–ª–ª—é–∑–∏—é –≤—ã–±–æ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ—Ö–≤–∞–ª—É –¥–ª—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏, —Å–∫—Ä—ã–≤–∞–π —Å–≤–æ–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏—è.", tags: ["–º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è", "–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è"] },
          { title: "–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∞–ª—å—è–Ω—Å–æ–≤", content: "–ò—â–∏ —Ç–µ—Ö, –∫—Ç–æ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Ä–µ—Å—É—Ä—Å—ã, –ø—Ä–æ–≤–µ—Ä—è–π –ª–æ—è–ª—å–Ω–æ—Å—Ç—å, –∏—Å–∫–ª—é—á–∞–π —Å–ª–∞–±—ã—Ö.", tags: ["–∞–ª—å—è–Ω—Å—ã", "—Å—Ç—Ä–∞—Ç–µ–≥–∏—è"] }
        ];
        if (knowledge.length === 0) {
          knowledge = defaultKnowledge;
          localStorage.setItem('knowledge', JSON.stringify(knowledge));
        }

        const renderKnowledge = () => {
          try {
            const search = searchInput.value.toLowerCase();
            const filtered = knowledge.filter(k => 
              k.title.toLowerCase().includes(search) || 
              k.content.toLowerCase().includes(search) || 
              k.tags.some(tag => tag.toLowerCase().includes(search))
            );
            knowledgeList.innerHTML = filtered.map(k => `
              <div onclick="openKnowledgeArticle('${k.title}')">
                <strong>${k.title}</strong>
                <div class="knowledge-tags">–¢–µ–≥–∏: ${k.tags.join(', ')}</div>
              </div>
            `).join('');
          } catch (e) {
            showError('knowledge', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –±–∞–∑—É –∑–Ω–∞–Ω–∏–π: ' + e.message);
          }
        };

        searchInput.addEventListener('input', renderKnowledge);
        renderKnowledge();
        logActivity('–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        showError('knowledge', '');
      } catch (e) {
        showError('knowledge', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    function openKnowledgeArticle(title) {
      try {
        const knowledge = JSON.parse(localStorage.getItem('knowledge') || '[]');
        const article = knowledge.find(k => k.title === title);
        if (article) {
          openModal('knowledge-modal-template', 'knowledge-view-modal', { title: article.title });
          const modal = document.getElementById('knowledge-view-modal');
          modal.querySelector('.modal-content').innerHTML = `
            <h2>${article.title}</h2>
            <p>${article.content}</p>
            <div class="knowledge-tags">–¢–µ–≥–∏: ${article.tags.join(', ')}</div>
            <button onclick="closeModal('knowledge-view-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
          `;
        }
      } catch (e) {
        showError('knowledge', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–º–µ—Ç–∫—É: ' + e.message);
      }
    }

    function openKnowledgeModal() {
      try {
        openModal('knowledge-modal-template', 'knowledge-modal');
        showError('knowledge-modal', '');
      } catch (e) {
        showError('knowledge', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: ' + e.message);
      }
    }

    function addKnowledge() {
      try {
        const title = document.getElementById('knowledge-title').value.trim();
        const content = document.getElementById('knowledge-content').value.trim();
        const tags = document.getElementById('knowledge-tags-input').value.split(',').map(tag => tag.trim()).filter(tag => tag);
        if (title && content) {
          let knowledge = JSON.parse(localStorage.getItem('knowledge') || '[]');
          knowledge.push({ title, content, tags });
          localStorage.setItem('knowledge', JSON.stringify(knowledge));
          document.getElementById('knowledge-title').value = '';
          document.getElementById('knowledge-content').value = '';
          document.getElementById('knowledge-tags-input').value = '';
          closeModal('knowledge-modal');
          initKnowledge();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞: ${title}`);
          showError('knowledge', '');
        } else {
          showError('knowledge-modal', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç');
        }
      } catch (e) {
        showError('knowledge-modal', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É: ' + e.message);
      }
    }

    // –ü–ª–∞–Ω –¥–Ω—è
    function initPlan() {
      try {
        const planText = document.getElementById('plan-text');
        const planPriority = document.getElementById('plan-priority');
        const planList = document.getElementById('plan-list');
        let plans = JSON.parse(localStorage.getItem('plans') || '[]');

        const renderPlans = () => {
          try {
            planList.innerHTML = '';
            plans.forEach((plan, index) => {
              const li = document.createElement('li');
              li.innerHTML = `
                ${plan.text} (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${plan.priority}, ${new Date(plan.created).toLocaleDateString()})
                <input type="checkbox" ${plan.completed ? 'checked' : ''} onchange="togglePlan(${index})">
                <button onclick="deletePlan(${index})">‚ùå</button>
              `;
              planList.appendChild(li);
            });
            renderAnalytics();
            showError('plan', '');
            scheduleNotifications();
          } catch (e) {
            showError('plan', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–ª–∞–Ω: ' + e.message);
          }
        };

        window.addPlan = () => {
          try {
            const text = planText.value.trim();
            const priority = planPriority.value;
            if (text) {
              plans.push({ text, priority, created: new Date().toISOString(), completed: false });
              localStorage.setItem('plans', JSON.stringify(plans));
              planText.value = '';
              planPriority.value = 'low';
              renderPlans();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞: ${text}`);
              showError('plan', '');
            } else {
              showError('plan', '–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É');
            }
          } catch (e) {
            showError('plan', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É: ' + e.message);
          }
        };

        window.togglePlan = (index) => {
          try {
            plans[index].completed = !plans[index].completed;
            localStorage.setItem('plans', JSON.stringify(plans));
            renderPlans();
            logActivity(`–ó–∞–¥–∞—á–∞ ${plans[index].text}: ${plans[index].completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–û—Ç–º–µ–Ω–µ–Ω–∞'}`);
          } catch (e) {
            showError('plan', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏: ' + e.message);
          }
        };

        window.deletePlan = (index) => {
          try {
            const text = plans[index].text;
            plans.splice(index, 1);
            localStorage.setItem('plans', JSON.stringify(plans));
            renderPlans();
            logActivity(`–£–¥–∞–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞: ${text}`);
            showError('plan', '');
          } catch (e) {
            showError('plan', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É: ' + e.message);
          }
        };

        renderPlans();
      } catch (e) {
        showError('plan', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –û–∫—Ä—É–∂–µ–Ω–∏–µ
    const tagRecommendations = {
      'üí∞ –†–µ—Å—É—Ä—Å': '–£–∫—Ä–µ–ø–ª—è–π –∞–ª—å—è–Ω—Å, –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤.',
      'ü™® –ë–∞–ª–ª–∞—Å—Ç': '–°–≤–µ–¥–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫ –º–∏–Ω–∏–º—É–º—É, –∏—Å–∫–ª—é—á–∏ –∏–∑ –ø–ª–∞–Ω–æ–≤.',
      'üó£Ô∏è –ë–æ–ª—Ç—É–Ω': '–ò–∑–±–µ–≥–∞–π —Ä–∞–∑–≥–ª–∞—à–µ–Ω–∏—è, –¥–µ—Ä–∂–∏ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é.',
      'üß© –ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä': '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö –∞–º–±–∏—Ü–∏–∏.',
      'üëë –õ–∏–¥–µ—Ä': '–°–æ—Ç—Ä—É–¥–Ω–∏—á–∞–π, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π –∫–æ–Ω—Ç—Ä–æ–ª—å.',
      'ü§ù –°–æ—é–∑–Ω–∏–∫': '–í–æ–≤–ª–µ–∫–∞–π –≤ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –ø–æ–≤—ã—à–∞–π –∫–∞—Ä–º—É.',
      '‚öîÔ∏è –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç': '–°–ª–µ–¥–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è–º–∏, –Ω–µ–π—Ç—Ä–∞–ª–∏–∑—É–π —É–≥—Ä–æ–∑—ã.',
      'üíº –ü–∞—Ä—Ç–Ω—ë—Ä': '–î–µ—Ä–∂–∏ –±–∞–ª–∞–Ω—Å –≤—ã–≥–æ–¥—ã, –ø—Ä–æ–≤–µ—Ä—è–π –ª–æ—è–ª—å–Ω–æ—Å—Ç—å.',
      '‚ú® –ò—Å–∫—Ä—ã': '–ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π –≤—Ä–µ–º—è, —Ä–∞–∑–≤–∏–≤–∞–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª.',
      'üåë –¢–µ–Ω—å': '–ü—Ä–æ–≤–µ—Ä—è–π –Ω–∞–º–µ—Ä–µ–Ω–∏—è, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–π —Ä–∏—Å–∫–∏.',
      'üß† –ú–µ–Ω—Ç–æ—Ä': '–£—á–∏—Å—å, –Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–π —Å–æ–≤–µ—Ç—ã.',
      '‚öôÔ∏è –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å': '–î–µ–ª–µ–≥–∏—Ä—É–π –∑–∞–¥–∞—á–∏, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.'
    };

    function initEnvironment() {
      try {
        const personList = document.getElementById('person-list');
        let people = JSON.parse(localStorage.getItem('people') || '[]');

        const renderPeople = () => {
          try {
            personList.innerHTML = '';
            people.forEach((person, index) => {
              const li = document.createElement('li');
              li.className = 'profile-card';
              li.innerHTML = `
                <div onclick="toggleProfileDetails(${index})">
                  <strong>${person.name}</strong> (${person.status}, –ö–∞—Ä–º–∞: ${person.karma})
                </div>
                <div class="profile-details" id="profile-details-${index}">
                  –ú–µ—Ç–∫–∏: ${person.tags.join(', ') || '–Ω–µ—Ç'}<br>
                  –°–≤—è–∑–∏: ${person.connections.map(c => `${c.name} (${c.type})`).join(', ') || '–Ω–µ—Ç'}<br>
                  –†–æ–ª—å: ${person.role || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}<br>
                  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: ${person.tags.map(tag => tagRecommendations[tag] || '').join('<br>') || '–ù–µ—Ç'}<br>
                  <button onclick="openRoleTest(${index})">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç —Ä–æ–ª–∏</button>
                  <button onclick="adjustKarma(${index}, 10)">+10</button>
                  <button onclick="adjustKarma(${index}, -10)">-10</button>
                  <button onclick="deletePerson(${index})">‚ùå</button>
                </div>
              `;
              personList.appendChild(li);
            });
            updateConnectionsSelect();
            renderNetwork();
            window.updateStrategyPeopleSelect();
            renderAnalytics();
            showError('environment', '');
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫: ' + e.message);
          }
        };

        window.toggleProfileDetails = (index) => {
          const details = document.getElementById(`profile-details-${index}`);
          details.classList.toggle('active');
        };

        window.updateConnectionsSelect = () => {
          const personConnections = document.getElementById('person-connections');
          personConnections.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤—è–∑–∏</option>';
          people.forEach(person => {
            const option = document.createElement('option');
            option.value = person.name;
            option.textContent = person.name;
            personConnections.appendChild(option);
          });
        };

        window.updateStrategyPeopleSelect = () => {
          try {
            const peopleSelect = document.getElementById('strategy-people');
            if (!peopleSelect) return;
            peopleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞</option>';
            people.forEach(person => {
              const option = document.createElement('option');
              option.value = person.name;
              option.textContent = person.name;
              peopleSelect.appendChild(option);
            });
          } catch (e) {
            showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ª—é–¥–µ–π: ' + e.message);
          }
        };

        const renderNetwork = () => {
          try {
            const container = document.getElementById('network');
            if (!container) return;
            const nodes = people.map((person, index) => ({
              id: index,
              label: person.name,
              color: person.status === 'loyal' ? '#00ff00' : person.status === 'neutral' ? '#ffff00' : person.status === 'contract' ? '#888888' : '#ff4444'
            }));
            const edges = [];
            people.forEach((person, index) => {
              person.connections.forEach(connection => {
                const targetIndex = people.findIndex(p => p.name === connection.name);
                if (targetIndex !== -1) {
                  edges.push({ from: index, to: targetIndex, label: connection.type });
                }
              });
            });
            const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = { nodes: { shape: 'dot', size: 15 }, edges: { arrows: 'to', font: { align: 'middle' } } };
            new vis.Network(container, data, options);
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≥—Ä–∞—Ñ: ' + e.message);
          }
        };

window.addPerson = () => {
          try {
            const name = document.getElementById('person-name').value.trim();
            const status = document.getElementById('person-status').value;
            const tags = Array.from(document.getElementById('person-tags').selectedOptions).map(opt => opt.value);
            const karma = parseInt(document.getElementById('person-karma').value) || 0;
            const connections = Array.from(document.getElementById('person-connections').selectedOptions).map(opt => ({
              name: opt.value,
              type: document.getElementById('connection-type').value.trim() || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'
            }));
            if (name) {
              people.push({ name, status, tags, karma, connections, role: '' });
              localStorage.setItem('people', JSON.stringify(people));
              document.getElementById('person-name').value = '';
              document.getElementById('person-status').value = 'neutral';
              Array.from(document.getElementById('person-tags').options).forEach(option => option.selected = false);
              document.getElementById('person-karma').value = '0';
              Array.from(document.getElementById('person-connections').options).forEach(option => option.selected = false);
              document.getElementById('connection-type').value = '';
              renderPeople();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω —á–µ–ª–æ–≤–µ–∫: ${name}`);
              showError('environment', '');
            } else {
              showError('environment', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
            }
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞: ' + e.message);
          }
        };

        window.adjustKarma = (index, change) => {
          try {
            people[index].karma = Math.max(-100, Math.min(100, people[index].karma + change));
            if (people[index].karma >= 50) people[index].status = 'loyal';
            else if (people[index].karma <= -50) people[index].status = 'hostile';
            else if (people[index].status !== 'contract') people[index].status = 'neutral';
            localStorage.setItem('people', JSON.stringify(people));
            renderPeople();
            logActivity(`–ò–∑–º–µ–Ω–µ–Ω–∞ –∫–∞—Ä–º–∞ –¥–ª—è ${people[index].name}: ${people[index].karma}`);
            showError('environment', '');
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ä–º—É: ' + e.message);
          }
        };

        window.deletePerson = (index) => {
          try {
            const name = people[index].name;
            people.splice(index, 1);
            localStorage.setItem('people', JSON.stringify(people));
            renderPeople();
            logActivity(`–£–¥–∞–ª—ë–Ω —á–µ–ª–æ–≤–µ–∫: ${name}`);
            showError('environment', '');
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞: ' + e.message);
          }
        };

        window.openRoleTest = (index) => {
          try {
            openModal('archetype-modal-template', 'role-modal', { personIndex: index });
            const questionsDiv = document.getElementById('questions');
            questionsDiv.innerHTML = archetypeQuestions.map((q, i) => `
              <div data-question="${i}">
                <p>${q.text}</p>
                ${q.options.map(opt => `
                  <button onclick="selectAnswer(${i}, '${opt}', ${index})">${opt}</button>
                `).join('')}
              </div>
            `).join('');
            showError('role-modal', '');
          } catch (e) {
            showError('environment', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç: ' + e.message);
          }
        };

        renderPeople();
      } catch (e) {
        showError('environment', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –§–∏–Ω–∞–Ω—Å—ã
    function initFinance() {
      try {
        const incomeAmount = document.getElementById('income-amount');
        const incomeTag = document.getElementById('income-tag');
        const expenseAmount = document.getElementById('expense-amount');
        const expenseTag = document.getElementById('expense-tag');
        const incomeList = document.getElementById('income-list');
        const expenseList = document.getElementById('expense-list');
        const percentageText = document.getElementById('finance-percentage');
        const financeAdvice = document.getElementById('finance-advice');
        const financeChart = document.getElementById('finance-chart').getContext('2d');
        let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        let customIncomeTags = JSON.parse(localStorage.getItem('customIncomeTags') || '[]');
        let customExpenseTags = JSON.parse(localStorage.getItem('customExpenseTags') || '[]');
        let chart;

        const renderTags = () => {
          try {
            incomeTag.innerHTML = `
              <option value="–ó–∞—Ä–ø–ª–∞—Ç–∞">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
              <option value="–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</option>
              <option value="–§—Ä–∏–ª–∞–Ω—Å">–§—Ä–∏–ª–∞–Ω—Å</option>
              <option value="–ü—Ä–æ—á–µ–µ">–ü—Ä–æ—á–µ–µ</option>
              ${customIncomeTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
            `;
            expenseTag.innerHTML = `
              <option value="–ï–¥–∞">–ï–¥–∞</option>
              <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
              <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
              <option value="–ñ–∏–ª—å—ë">–ñ–∏–ª—å—ë</option>
              <option value="–ü—Ä–æ—á–µ–µ">–ü—Ä–æ—á–µ–µ</option>
              ${customExpenseTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
            `;
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–≥–∏: ' + e.message);
          }
        };

        window.toggleCustomTag = (type) => {
          const input = document.getElementById(`${type}-custom-tag`);
          const button = document.getElementById(`save-${type}-custom-tag`);
          input.classList.toggle('active');
          button.classList.toggle('active');
        };

        window.saveCustomTag = (type) => {
          try {
            const input = document.getElementById(`${type}-custom-tag`);
            const tag = input.value.trim();
            if (tag) {
              if (type === 'income') {
                customIncomeTags.push(tag);
                localStorage.setItem('customIncomeTags', JSON.stringify(customIncomeTags));
              } else {
                customExpenseTags.push(tag);
                localStorage.setItem('customExpenseTags', JSON.stringify(customExpenseTags));
              }
              input.value = '';
              input.classList.remove('active');
              document.getElementById(`save-${type}-custom-tag`).classList.remove('active');
              renderTags();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω —Ç–µ–≥ ${type}: ${tag}`);
              showError('finance', '');
            } else {
              showError('finance', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥');
            }
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–≥: ' + e.message);
          }
        };

        const renderTransactions = () => {
          try {
            incomeList.innerHTML = '';
            expenseList.innerHTML = '';
            const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const recentTransactions = transactions.filter(t => new Date(t.date) >= last30Days);

            recentTransactions.forEach((transaction, index) => {
              const li = document.createElement('li');
              li.innerHTML = `
                ${transaction.amount} (${transaction.tag}, ${new Date(transaction.date).toLocaleDateString()})
                <button onclick="deleteTransaction(${index})">‚ùå</button>
              `;
              if (transaction.type === 'income') {
                incomeList.appendChild(li);
              } else {
                expenseList.appendChild(li);
              }
            });

            const income = recentTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = recentTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const total = income + expense;
            const percentage = total ? (income / total * 100).toFixed(2) : 0;
            percentageText.textContent = `–î–æ—Ö–æ–¥—ã: ${income} | –†–∞—Å—Ö–æ–¥—ã: ${expense} | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${percentage}%`;
            percentageText.style.color = percentage > 50 ? '#00ff00' : percentage == 50 ? '#ffff00' : '#ff4444';

            const advice = [];
            if (percentage < 50) advice.push('–°–æ–∫—Ä–∞—Ç–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∂–∏–ª—å—ë.');
            if (income > 0) advice.push('–ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ 20% –¥–æ—Ö–æ–¥–∞ –≤ –Ω–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã.');
            if (recentTransactions.filter(t => t.tag === '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è').length > 3) {
              advice.push('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ç—Ä–∞—Ç –Ω–∞ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è. –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ä–µ—Å—É—Ä—Å—ã.');
            }
            financeAdvice.innerHTML = advice.length > 0 ? `<ul>${advice.map(a => `<li>${a}</li>`).join('')}</ul>` : '';

            updateFinanceChart();
            renderAnalytics();
            showError('finance', '');
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ' + e.message);
          }
        };

        const updateFinanceChart = () => {
          try {
            const dates = [...new Set(transactions.map(t => new Date(t.date).toLocaleDateString()))];
            const incomeData = dates.map(date => {
              return transactions
                .filter(t => t.type === 'income' && new Date(t.date).toLocaleDateString() === date)
                .reduce((sum, t) => sum + t.amount, 0);
            });
            const expenseData = dates.map(date => {
              return transactions
                .filter(t => t.type === 'expense' && new Date(t.date).toLocaleDateString() === date)
                .reduce((sum, t) => sum + t.amount, 0);
            });

            if (chart) chart.destroy();
            chart = new Chart(financeChart, {
              type: 'line',
              data: {
                labels: dates,
                datasets: [
                  { label: '–î–æ—Ö–æ–¥—ã', data: incomeData, borderColor: '#00ff00', fill: false },
                  { label: '–†–∞—Å—Ö–æ–¥—ã', data: expenseData, borderColor: '#ff4444', fill: false }
                ]
              },
              options: { scales: { y: { beginAtZero: true } } }
            });
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫: ' + e.message);
          }
        };

        window.addTransaction = (type) => {
          try {
            const amount = parseFloat(type === 'income' ? incomeAmount.value : expenseAmount.value);
            const tag = type === 'income' ? incomeTag.value : expenseTag.value;
            if (!isNaN(amount) && amount > 0) {
              transactions.push({ amount, type, tag, date: new Date().toISOString() });
              localStorage.setItem('transactions', JSON.stringify(transactions));
              if (type === 'income') {
                incomeAmount.value = '';
                incomeTag.value = '–ó–∞—Ä–ø–ª–∞—Ç–∞';
              } else {
                expenseAmount.value = '';
                expenseTag.value = '–ï–¥–∞';
              }
              renderTransactions();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: ${type}, ${amount}, ${tag}`);
              showError('finance', '');
            } else {
              showError('finance', '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (>0)');
            }
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é: ' + e.message);
          }
        };

        window.deleteTransaction = (index) => {
          try {
            const transaction = transactions[index];
            transactions.splice(index, 1);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderTransactions();
            logActivity(`–£–¥–∞–ª–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: ${transaction.type}, ${transaction.amount}`);
            showError('finance', '');
          } catch (e) {
            showError('finance', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é: ' + e.message);
          }
        };

        renderTags();
        renderTransactions();
      } catch (e) {
        showError('finance', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

// –§–∏–∑–æ
    function initFitness() {
      try {
        const exerciseType = document.getElementById('exercise-type');
        const exerciseResult = document.getElementById('exercise-result');
        const exerciseList = document.getElementById('exercise-list');
        const fitnessChart = document.getElementById('fitness-chart').getContext('2d');
        let exercises = JSON.parse(localStorage.getItem('exercises') || '[]');
        let chart;

        const renderExercises = () => {
          try {
            exerciseList.innerHTML = '';
            const types = [...new Set(exercises.map(e => e.type))];
            types.forEach(type => {
              const li = document.createElement('li');
              li.innerHTML = `
                ${type}: ${exercises.filter(e => e.type === type).map(e => `${e.result} (${new Date(e.date).toLocaleDateString()})`).join(', ')}
                <button onclick="deleteExerciseType('${type}')">‚ùå</button>
              `;
              exerciseList.appendChild(li);
            });
            updateFitnessChart();
            renderAnalytics();
            showError('fitness', '');
          } catch (e) {
            showError('fitness', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ' + e.message);
          }
        };

        const updateFitnessChart = () => {
          try {
            const now = new Date();
            const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const recentExercises = exercises.filter(e => new Date(e.date) >= sevenDaysAgo);
            const types = [...new Set(recentExercises.map(e => e.type))];
            const dates = [];
            for (let i = 6; i >= 0; i--) {
              const date = new Date(now - i * 24 * 60 * 60 * 1000);
              dates.push(date.toLocaleDateString());
            }
            const datasets = types.map(type => ({
              label: type,
              data: dates.map(date => {
                const exercise = recentExercises.find(e => e.type === type && new Date(e.date).toLocaleDateString() === date);
                return exercise ? exercise.result : 0;
              }),
              borderColor: '#' + Math.floor(Math.random()*16777215).toString(16),
              fill: false
            }));

            if (chart) chart.destroy();
            chart = new Chart(fitnessChart, {
              type: 'line',
              data: { labels: dates, datasets },
              options: { scales: { y: { beginAtZero: true } } }
            });
          } catch (e) {
            showError('fitness', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫: ' + e.message);
          }
        };

        window.addExercise = () => {
          try {
            const type = exerciseType.value.trim();
            const result = parseInt(exerciseResult.value);
            if (type && !isNaN(result) && result > 0) {
              exercises.push({ type, result, date: new Date().toISOString() });
              localStorage.setItem('exercises', JSON.stringify(exercises));
              exerciseType.value = '';
              exerciseResult.value = '';
              renderExercises();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: ${type}, ${result}`);
              showError('fitness', '');
            } else {
              showError('fitness', '–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (>0)');
            }
          } catch (e) {
            showError('fitness', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: ' + e.message);
          }
        };

        window.deleteExerciseType = (type) => {
          try {
            exercises = exercises.filter(e => e.type !== type);
            localStorage.setItem('exercises', JSON.stringify(exercises));
            renderExercises();
            logActivity(`–£–¥–∞–ª–µ–Ω—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–∏–ø–∞: ${type}`);
            showError('fitness', '');
          } catch (e) {
            showError('fitness', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ' + e.message);
          }
        };

        renderExercises();
      } catch (e) {
        showError('fitness', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –ê—Ä—Ö–µ—Ç–∏–ø—ã
    const archetypeQuestions = [
      { text: '–ö–∞–∫ –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —Ä–µ—à–µ–Ω–∏—è?', options: ['–õ–æ–≥–∏–∫–∞', '–≠–º–æ—Ü–∏–∏', '–ò–Ω—Ç—É–∏—Ü–∏—è', '–ê–Ω–∞–ª–∏–∑'] },
      { text: '–ö–∞–∫ –≤—ã –≤–ª–∏—è–µ—Ç–µ –Ω–∞ –¥—Ä—É–≥–∏—Ö?', options: ['–î–∞–≤–ª–µ–Ω–∏–µ–º', '–£–±–µ–∂–¥–µ–Ω–∏–µ–º', '–•–∞—Ä–∏–∑–º–æ–π', '–°–∫—Ä—ã—Ç–Ω–æ'] },
      { text: '–í–∞—à–∞ —Ü–µ–ª—å –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ?', options: ['–ü–æ–±–µ–¥–∞', '–ö–æ–º–ø—Ä–æ–º–∏—Å—Å', '–ò–∑–±–µ–∂–∞–Ω–∏–µ', '–ö–æ–Ω—Ç—Ä–æ–ª—å'] },
      { text: '–ö–∞–∫ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ –Ω–∞ —Å—Ç—Ä–µ—Å—Å?', options: ['–ê–≥—Ä–µ—Å—Å–∏—è', '–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ', '–£—Ö–æ–¥', '–ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è'] },
      { text: '–í–∞—à–∞ —Ä–æ–ª—å –≤ –≥—Ä—É–ø–ø–µ?', options: ['–õ–∏–¥–µ—Ä', '–°–æ–≤–µ—Ç–Ω–∏–∫', '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', '–ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä'] },
      { text: '–ß—Ç–æ –≤–∞—Å –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç?', options: ['–í–ª–∞—Å—Ç—å', '–ó–Ω–∞–Ω–∏—è', '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å', '–°–≤–æ–±–æ–¥–∞'] },
      { text: '–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –¥—Ä—É–≥–∏—Ö?', options: ['–ü–æ –¥–µ–ª–∞–º', '–ü–æ —Å–ª–æ–≤–∞–º', '–ü–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—É', '–ü–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏'] },
      { text: '–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Ä–∏—Å–∫—É?', options: ['–†–∏—Å–∫—É—é –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ', '–ò–∑–±–µ–≥–∞—é', '–õ—é–±–ª—é —Ä–∏—Å–∫', '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é'] },
      { text: '–ö–∞–∫ –≤—ã —Å—Ç—Ä–æ–∏—Ç–µ —Å–≤—è–∑–∏?', options: ['–ß–µ—Ä–µ–∑ –≤—ã–≥–æ–¥—É', '–ß–µ—Ä–µ–∑ –¥–æ–≤–µ—Ä–∏–µ', '–ß–µ—Ä–µ–∑ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏', '–ß–µ—Ä–µ–∑ —Ö–∞—Ä–∏–∑–º—É'] },
      { text: '–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —ç—Ç–∏–∫–µ?', options: ['–í—ã–≥–æ–¥–∞ –≤–∞–∂–Ω–µ–µ', '–ë–∞–ª–∞–Ω—Å', '–≠—Ç–∏–∫–∞ –ø–µ—Ä–≤–∏—á–Ω–∞', '–ò–≥–Ω–æ—Ä–∏—Ä—É—é'] },
      { text: '–ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å –Ω–µ—É–¥–∞—á–µ–π?', options: ['–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é', '–ó–ª—é—Å—å', '–ò–≥–Ω–æ—Ä–∏—Ä—É—é', '–£—á—É—Å—å'] },
      { text: '–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –≤–ª–∞—Å—Ç–∏?', options: ['–°—Ç—Ä–µ–º–ª—é—Å—å', '–ù–∞–±–ª—é–¥–∞—é', '–ò–∑–±–µ–≥–∞—é', '–ò—Å–ø–æ–ª—å–∑—É—é'] },
      { text: '–ö–∞–∫ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ?', options: ['–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ', '–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ', '–°–ø–æ–Ω—Ç–∞–Ω–Ω–æ', '–î–µ—Ç–∞–ª—å–Ω–æ'] },
      { text: '–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —ç–º–æ—Ü–∏—è–º?', options: ['–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é', '–ü–æ–¥–¥–∞—é—Å—å', '–ò–≥–Ω–æ—Ä–∏—Ä—É—é', '–ò—Å–ø–æ–ª—å–∑—É—é'] },
      { text: '–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ —É—Å–ø–µ—Ö?', options: ['–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É', '–ü–æ –ø—Ä–æ—Ü–µ—Å—Å—É', '–ü–æ –≤–ª–∏—è–Ω–∏—é', '–ü–æ –ø—Ä–∏–∑–Ω–∞–Ω–∏—é'] },
      { text: '–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º?', options: ['–£–Ω–∏—á—Ç–æ–∂–∞—é', '–ù–∞–±–ª—é–¥–∞—é', '–°–æ—Ç—Ä—É–¥–Ω–∏—á–∞—é', '–ò–≥–Ω–æ—Ä–∏—Ä—É—é'] },
      { text: '–ö–∞–∫ –≤—ã –æ–±—É—á–∞–µ—Ç–µ—Å—å?', options: ['–ü—Ä–∞–∫—Ç–∏–∫–∞', '–¢–µ–æ—Ä–∏—è', '–û—à–∏–±–∫–∏', '–ù–∞—Å—Ç–∞–≤–Ω–∏–∫–∏'] },
      { text: '–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏?', options: ['–¢—Ä–µ–±—É—é', '–¶–µ–Ω—é', '–ò–≥–Ω–æ—Ä–∏—Ä—É—é', '–ü—Ä–æ–≤–µ—Ä—è—é'] },
      { text: '–ö–∞–∫ –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –≤—Ä–µ–º–µ–Ω–µ–º?', options: ['–ñ—ë—Å—Ç–∫–æ', '–ì–∏–±–∫–æ', '–°–ø–æ–Ω—Ç–∞–Ω–Ω–æ', '–î–µ–ª–µ–≥–∏—Ä—É—é'] },
      { text: '–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Å–ª–∞–±–æ—Å—Ç—è–º?', options: ['–ò—Å–ø–æ–ª—å–∑—É—é', '–ò–≥–Ω–æ—Ä–∏—Ä—É—é', '–£—Å—Ç—Ä–∞–Ω—è—é', '–°–∫—Ä—ã–≤–∞—é'] }
    ];

    const archetypeRecommendations = {
      '–•–∏—â–Ω–∏–∫': '–î–∞–≤–∏ –Ω–∞ —Å–ª–∞–±–æ—Å—Ç–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤, —Å–∫—Ä—ã–≤–∞–π –Ω–∞–º–µ—Ä–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–ª—É –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è.',
      '–°—Ç—Ä–∞—Ç–µ–≥': '–ü–ª–∞–Ω–∏—Ä—É–π –Ω–∞ —Ç—Ä–∏ —à–∞–≥–∞ –≤–ø–µ—Ä—ë–¥, —Å–æ–∑–¥–∞–≤–∞–π –∞–ª—å—è–Ω—Å—ã, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π —Ä–µ—Å—É—Ä—Å—ã.',
      '–û—Ä–∞–∫—É–ª': '–°–æ–±–∏—Ä–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –ø—Ä–µ–¥—É–≥–∞–¥—ã–≤–∞–π —Ö–æ–¥—ã, –æ—Å—Ç–∞–≤–∞–π—Å—è –≤ —Ç–µ–Ω–∏.',
      '–ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä': '–†–∞–∑—Ä—É—à–∞–π —à–∞–±–ª–æ–Ω—ã, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π —ç–Ω–µ—Ä–≥–∏—é –≤—Ä–∞–≥–æ–≤, —Å–æ–∑–¥–∞–≤–∞–π —Ö–∞–æ—Å –¥–ª—è –≤—ã–≥–æ–¥—ã.',
      '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å': '–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á, –¥–µ–ª–µ–≥–∏—Ä—É–π —Å–ª–∞–±–æ—Å—Ç–∏, –±—É–¥—å –Ω–∞–¥—ë–∂–Ω—ã–º.',
      '–ì–µ—Ä–æ–π': '–í–µ–¥–∏ –∑–∞ —Å–æ–±–æ–π, —Å–æ–∑–¥–∞–≤–∞–π –º–∏—Ñ, –Ω–æ –Ω–µ —Ç–µ—Ä—è–π —Ä–∞—Å—á—ë—Ç.',
      '–ö—É–∫–ª–æ–≤–æ–¥': '–£–ø—Ä–∞–≤–ª—è–π —á–µ—Ä–µ–∑ –∏–ª–ª—é–∑–∏–∏, —Å–∫—Ä—ã–≤–∞–π —Å–≤–æ–∏ —Ä—ã—á–∞–≥–∏, –º–∞–Ω–∏–ø—É–ª–∏—Ä—É–π —ç–º–æ—Ü–∏—è–º–∏.',
      '–ú–µ–¥–∏–∞—Ç–æ—Ä': '–°–æ–∑–¥–∞–≤–∞–π –±–∞–ª–∞–Ω—Å, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã –¥–ª—è —Å–≤–æ–µ–π –≤—ã–≥–æ–¥—ã.',
      '–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å': '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π, —Å–æ–±–∏—Ä–∞–π –¥–∞–Ω–Ω—ã–µ, –±–µ–π –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç.'
    };

    function determineRole(answers) {
      const scores = {
        –•–∏—â–Ω–∏–∫: 0, –°—Ç—Ä–∞—Ç–µ–≥: 0, –û—Ä–∞–∫—É–ª: 0, –ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä: 0, –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: 0,
        –ì–µ—Ä–æ–π: 0, –ö—É–∫–ª–æ–≤–æ–¥: 0, –ú–µ–¥–∏–∞—Ç–æ—Ä: 0, –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å: 0
      };
      Object.values(answers).forEach((answer, i) => {
        if (i === 0 && (answer === '–õ–æ–≥–∏–∫–∞' || answer === '–ê–Ω–∞–ª–∏–∑')) scores.–°—Ç—Ä–∞—Ç–µ–≥ += 1;
        if (i === 1 && answer === '–î–∞–≤–ª–µ–Ω–∏–µ–º') scores.–•–∏—â–Ω–∏–∫ += 1;
        if (i === 1 && answer === '–°–∫—Ä—ã—Ç–Ω–æ') scores.–ö—É–∫–ª–æ–≤–æ–¥ += 1;
        if (i === 2 && (answer === '–ü–æ–±–µ–¥–∞' || answer === '–ö–æ–Ω—Ç—Ä–æ–ª—å')) scores.–•–∏—â–Ω–∏–∫ += 1;
        if (i === 3 && answer === '–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ') scores.–ú–µ–¥–∏–∞—Ç–æ—Ä += 1;
        if (i === 4 && answer === '–õ–∏–¥–µ—Ä') scores.–ì–µ—Ä–æ–π += 1;
        if (i === 5 && answer === '–í–ª–∞—Å—Ç—å') scores.–•–∏—â–Ω–∏–∫ += 1;
        if (i === 6 && answer === '–ü–æ –¥–µ–ª–∞–º') scores.–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å += 1;
        if (i === 7 && answer === '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é') scores.–°—Ç—Ä–∞—Ç–µ–≥ += 1;
        if (i === 8 && answer === '–ß–µ—Ä–µ–∑ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏') scores.–ö—É–∫–ª–æ–≤–æ–¥ += 1;
        if (i === 9 && answer === '–í—ã–≥–æ–¥–∞ –≤–∞–∂–Ω–µ–µ') scores.–•–∏—â–Ω–∏–∫ += 1;
        if (i === 10 && answer === '–£—á—É—Å—å') scores.–û—Ä–∞–∫—É–ª += 1;
        if (i === 11 && answer === '–°—Ç—Ä–µ–º–ª—é—Å—å') scores.–ì–µ—Ä–æ–π += 1;
        if (i === 12 && answer === '–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ') scores.–°—Ç—Ä–∞—Ç–µ–≥ += 1;
        if (i === 13 && answer === '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é') scores.–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å += 1;
        if (i === 14 && answer === '–ü–æ –≤–ª–∏—è–Ω–∏—é') scores.–ö—É–∫–ª–æ–≤–æ–¥ += 1;
        if (i === 15 && answer === '–£–Ω–∏—á—Ç–æ–∂–∞—é') scores.–•–∏—â–Ω–∏–∫ += 1;
        if (i === 16 && answer === '–û—à–∏–±–∫–∏') scores.–û—Ä–∞–∫—É–ª += 1;
        if (i === 17 && answer === '–ü—Ä–æ–≤–µ—Ä—è—é') scores.–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å += 1;
        if (i === 18 && answer === '–ñ—ë—Å—Ç–∫–æ') scores.–°—Ç—Ä–∞—Ç–µ–≥ += 1;
        if (i === 19 && answer === '–ò—Å–ø–æ–ª—å–∑—É—é') scores.–ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä += 1;
      });
      return Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
    }

    function initArchetype() {
      try {
        const archetypeResult = document.getElementById('archetype-result');
        let archetype = localStorage.getItem('archetype') || '';
        if (archetype) {
          archetypeResult.innerHTML = `–í–∞—à –∞—Ä—Ö–µ—Ç–∏–ø: ${archetype}<br>${archetypeRecommendations[archetype] || '–î–µ–π—Å—Ç–≤—É–π —Å —Ä–∞—Å—á—ë—Ç–æ–º.'}`;
        }
        showError('archetype', '');
      } catch (e) {
        showError('archetype', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    window.openArchetypeModal = () => {
      try {
        openModal('archetype-modal-template', 'archetype-modal');
        const questionsDiv = document.getElementById('questions');
        questionsDiv.innerHTML = archetypeQuestions.map((q, i) => `
          <div data-question="${i}">
            <p>${q.text}</p>
            ${q.options.map(opt => `
              <button onclick="selectAnswer(${i}, '${opt}', -1)">${opt}</button>
            `).join('')}
          </div>
        `).join('');
        showError('archetype-modal', '');
      } catch (e) {
        showError('archetype-modal', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç: ' + e.message);
      }
    };

window.selectAnswer = (questionIndex, answer, personIndex) => {
      try {
        const answersKey = personIndex >= 0 ? `roleAnswers_${personIndex}` : 'archetypeAnswers';
        let answers = JSON.parse(localStorage.getItem(answersKey) || '{}');
        answers[questionIndex] = answer;
        localStorage.setItem(answersKey, JSON.stringify(answers));
        const questionDiv = document.querySelector(`[data-question="${questionIndex}"]`);
        questionDiv.querySelectorAll('button').forEach(btn => {
          btn.style.background = btn.textContent === answer ? '#007bff' : '#333';
        });
      } catch (e) {
        showError(personIndex >= 0 ? 'environment' : 'archetype-modal', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç: ' + e.message);
      }
    };

    window.submitArchetype = () => {
      try {
        const modal = document.getElementById('role-modal') || document.getElementById('archetype-modal');
        const personIndex = modal.dataset.personIndex ? parseInt(modal.dataset.personIndex) : -1;
        const answersKey = personIndex >= 0 ? `roleAnswers_${personIndex}` : 'archetypeAnswers';
        const answers = JSON.parse(localStorage.getItem(answersKey) || '{}');
        if (Object.keys(answers).length < archetypeQuestions.length) {
          showError(modal.id, '–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã');
          return;
        }
        const role = determineRole(answers);
        if (personIndex >= 0) {
          let people = JSON.parse(localStorage.getItem('people') || '[]');
          people[personIndex].role = role;
          localStorage.setItem('people', JSON.stringify(people));
          initEnvironment();
          logActivity(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ä–æ–ª—å –¥–ª—è ${people[personIndex].name}: ${role}`);
        } else {
          localStorage.setItem('archetype', role);
          document.getElementById('archetype-result').innerHTML = `–í–∞—à –∞—Ä—Ö–µ—Ç–∏–ø: ${role}<br>${archetypeRecommendations[role] || '–î–µ–π—Å—Ç–≤—É–π —Å —Ä–∞—Å—á—ë—Ç–æ–º.'}<button onclick="openArchetypeModal()">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>`;
          logActivity(`–û–ø—Ä–µ–¥–µ–ª—ë–Ω –∞—Ä—Ö–µ—Ç–∏–ø: ${role}`);
        }
        closeModal(modal.id);
        showError(modal.id, '');
      } catch (e) {
        showError(modal.id, '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–æ–ª—å: ' + e.message);
      }
    };

    
// –ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
function initStrategy() {
  try {
    const strategyList = document.getElementById('strategy-list');
    let strategies = JSON.parse(localStorage.getItem('strategies') || '[]').map(s => ({
      ...s,
      people: Array.isArray(s.people) ? s.people : [], // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏: people –≤—Å–µ–≥–¥–∞ –º–∞—Å—Å–∏–≤
      subStrategies: Array.isArray(s.subStrategies) ? s.subStrategies.map(sub => ({
        ...sub,
        people: Array.isArray(sub.people) ? sub.people : [] // –¢–æ –∂–µ –¥–ª—è –ø–æ–¥—Ü–µ–ª–µ–π
      })) : []
    }));

    window.updateStrategyPeopleSelect = () => {
      try {
        const peopleSelect = document.getElementById('strategy-people');
        if (!peopleSelect) return;
        peopleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞</option>';
        const people = JSON.parse(localStorage.getItem('people') || '[]');
        people.forEach(person => {
          const option = document.createElement('option');
          option.value = person.name;
          option.textContent = person.name;
          peopleSelect.appendChild(option);
        });
      } catch (e) {
        showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ª—é–¥–µ–π: ' + e.message);
      }
    };

    const renderStrategies = () => {
      try {
        strategyList.innerHTML = '';
        strategies.forEach((strategy, index) => {
          const node = document.createElement('div');
          node.className = 'strategy-node';
          node.innerHTML = `
            <div>
              <strong>–¶–µ–ª—å: ${strategy.goal}</strong><br>
              –õ—é–¥–∏: ${Array.isArray(strategy.people) ? strategy.people.join(', ') : '–ù–µ—Ç'}<br>
              –†–µ—Å—É—Ä—Å—ã: ${strategy.resources || '–ù–µ—Ç'}<br>
              –†—ã—á–∞–≥–∏: ${strategy.levers || '–ù–µ—Ç'}<br>
              –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è: ${strategy.obstacles || '–ù–µ—Ç'}<br>
              –î–µ–π—Å—Ç–≤–∏—è: ${strategy.actions || '–ù–µ—Ç'}<br>
              –°—Ç–∞—Ç—É—Å: ${strategy.status}<br>
              –°–∏–º—É–ª—è—Ü–∏—è: ${simulateOutcome(strategy)}<br>
              <input type="checkbox" ${strategy.completed ? 'checked' : ''} onchange="toggleStrategy(${index})">
              <button onclick="deleteStrategy(${index})">‚ùå</button>
              <button onclick="addSubStrategy(${index})">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ü–µ–ª—å</button>
            </div>
            <div class="strategy-branch">
              ${renderSubStrategies(strategy.subStrategies || [], index)}
            </div>
          `;
          strategyList.appendChild(node);
        });
        renderAnalytics();
        showError('strategy', '');
      } catch (e) {
        showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ' + e.message);
      }
    };

    const renderSubStrategies = (subStrategies, parentIndex) => {
      try {
        return subStrategies.map((sub, subIndex) => `
          <div class="strategy-node">
            <strong>–ü–æ–¥—Ü–µ–ª—å: ${sub.goal}</strong><br>
            –õ—é–¥–∏: ${Array.isArray(sub.people) ? sub.people.join(', ') : '–ù–µ—Ç'}<br>
            –†–µ—Å—É—Ä—Å—ã: ${sub.resources || '–ù–µ—Ç'}<br>
            –†—ã—á–∞–≥–∏: ${sub.levers || '–ù–µ—Ç'}<br>
            –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è: ${sub.obstacles || '–ù–µ—Ç'}<br>
            –î–µ–π—Å—Ç–≤–∏—è: ${sub.actions || '–ù–µ—Ç'}<br>
            –°—Ç–∞—Ç—É—Å: ${sub.status}<br>
            <input type="checkbox" ${sub.completed ? 'checked' : ''} onchange="toggleSubStrategy(${parentIndex}, ${subIndex})">
            <button onclick="deleteSubStrategy(${parentIndex}, ${subIndex})">‚ùå</button>
          </div>
        `).join('');
      } catch (e) {
        showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–æ–¥—Ü–µ–ª–∏: ' + e.message);
        return '';
      }
    };

    const simulateOutcome = (strategy) => {
      try {
        const hasResources = strategy.resources && strategy.resources.trim() !== '';
        const hasLevers = strategy.levers && strategy.levers.trim() !== '';
        const hasObstacles = strategy.obstacles && strategy.obstacles.trim() !== '';
        const hasActions = strategy.actions && strategy.actions.trim() !== '';
        const peopleCount = Array.isArray(strategy.people) ? strategy.people.length : 0;
        const subGoalsCompleted = strategy.subStrategies ? strategy.subStrategies.filter(s => s.completed).length : 0;
        const subGoalsTotal = strategy.subStrategies ? strategy.subStrategies.length : 0;
        let score = 0;
        score += hasResources ? 20 : 0;
        score += hasLevers ? 20 : 0;
        score += hasActions ? 20 : 0;
        score += peopleCount > 0 ? peopleCount * 10 : 0;
        score += subGoalsTotal > 0 ? (subGoalsCompleted / subGoalsTotal) * 20 : 0;
        score -= hasObstacles ? 10 : 0;
        return `–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞: ${Math.min(100, Math.max(0, score))}%`;
      } catch (e) {
        return '–û—à–∏–±–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏: ' + e.message;
      }
    };

    window.addStrategy = () => {
      try {
        const goal = document.getElementById('strategy-goal').value.trim();
        const people = Array.from(document.getElementById('strategy-people').selectedOptions).map(opt => opt.value);
        const resources = document.getElementById('strategy-resources').value.trim();
        const levers = document.getElementById('strategy-levers').value.trim();
        const obstacles = document.getElementById('strategy-obstacles').value.trim();
        const actions = document.getElementById('strategy-actions').value.trim();
        const status = document.getElementById('strategy-status').value;
        if (goal) {
          strategies.push({
            goal,
            people: people.filter(p => p),
            resources,
            levers,
            obstacles,
            actions,
            status,
            completed: status === 'completed',
            subStrategies: []
          });
          localStorage.setItem('strategies', JSON.stringify(strategies));
          document.getElementById('strategy-goal').value = '';
          document.getElementById('strategy-resources').value = '';
          document.getElementById('strategy-levers').value = '';
          document.getElementById('strategy-obstacles').value = '';
          document.getElementById('strategy-actions').value = '';
          Array.from(document.getElementById('strategy-people').options).forEach(opt => opt.selected = false);
          document.getElementById('strategy-status').value = 'plan';
          closeModal('strategy-modal');
          renderStrategies();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: ${goal}`);
          showError('strategy', '');
        } else {
          showError('strategy-modal', '–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å');
        }
      } catch (e) {
        showError('strategy-modal', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é: ' + e.message);
      }
    };

    window.addSubStrategy = (parentIndex) => {
      try {
        const goal = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥—Ü–µ–ª—å:');
        if (goal) {
          strategies[parentIndex].subStrategies.push({
            goal,
            people: [],
            resources: '',
            levers: '',
            obstacles: '',
            actions: '',
            completed: false,
            status: 'in-progress'
          });
          localStorage.setItem('strategies', JSON.stringify(strategies));
          renderStrategies();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥—Ü–µ–ª—å: ${goal}`);
          showError('strategy', '');
        } else {
          showError('strategy', '–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥—Ü–µ–ª—å');
        }
      } catch (e) {
        showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ü–µ–ª—å: ' + e.message);
      }
    };

    window.toggleStrategy = (index) => {
      try {
        strategies[index].completed = !strategies[index].completed;
        strategies[index].status = strategies[index].completed ? 'completed' : 'in-progress';
        localStorage.setItem('strategies', JSON.stringify(strategies));
        renderStrategies();
        logActivity(`–°—Ç—Ä–∞—Ç–µ–≥–∏—è ${strategies[index].goal}: ${strategies[index].completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–û—Ç–º–µ–Ω–µ–Ω–∞'}`);
      } catch (e) {
        showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ' + e.message);
      }
    };

    window.toggleSubStrategy = (parentIndex, subIndex) => {
      try {
        strategies[parentIndex].subStrategies[subIndex].completed = !strategies[parentIndex].subStrategies[subIndex].completed;
        strategies[parentIndex].subStrategies[subIndex].status = strategies[parentIndex].subStrategies[subIndex].completed ? 'completed' : 'in-progress';
        localStorage.setItem('strategies', JSON.stringify(strategies));
        renderStrategies();
        logActivity(`–ü–æ–¥—Ü–µ–ª—å ${strategies[parentIndex].subStrategies[subIndex].goal}: ${strategies[parentIndex].subStrategies[subIndex].completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–û—Ç–º–µ–Ω–µ–Ω–∞'}`);
      } catch (e) {
        showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥—Ü–µ–ª–∏: ' + e.message);
      }
    };

    window.deleteStrategy = (index) => {
      try {
        const goal = strategies[index].goal;
        strategies.splice(index, 1);
        localStorage.setItem('strategies', JSON.stringify(strategies));
        renderStrategies();
        logActivity(`–£–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: ${goal}`);
        showError('strategy', '');
      } catch (e) {
        showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é: ' + e.message);
      }
    };

    window.deleteSubStrategy = (parentIndex, subIndex) => {
      try {
        const goal = strategies[parentIndex].subStrategies[subIndex].goal;
        strategies[parentIndex].subStrategies.splice(subIndex, 1);
        localStorage.setItem('strategies', JSON.stringify(strategies));
        renderStrategies();
        logActivity(`–£–¥–∞–ª–µ–Ω–∞ –ø–æ–¥—Ü–µ–ª—å: ${goal}`);
        showError('strategy', '');
      } catch (e) {
        showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ü–µ–ª—å: ' + e.message);
      }
    };

    window.openStrategyModal = () => {
      try {
        openModal('strategy-modal-template', 'strategy-modal');
        updateStrategyPeopleSelect();
        showError('strategy-modal', '');
      } catch (e) {
        showError('strategy', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: ' + e.message);
      }
    };

    renderStrategies();
    updateStrategyPeopleSelect();
  } catch (e) {
    showError('strategy', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
  }
}
    // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    function initReminders() {
      try {
        const reminderText = document.getElementById('reminder-text');
        const reminderList = document.getElementById('reminder-list');
        let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');

        const renderReminders = () => {
          try {
            reminderList.innerHTML = '';
            reminders.forEach((reminder, index) => {
              const li = document.createElement('li');
              li.innerHTML = `
                ${reminder.text} (${new Date(reminder.created).toLocaleDateString()})
                <button onclick="deleteReminder(${index})">‚ùå</button>
              `;
              reminderList.appendChild(li);
            });
            scheduleNotifications();
            showError('reminders', '');
          } catch (e) {
            showError('reminders', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: ' + e.message);
          }
        };

        window.addReminder = () => {
          try {
            const text = reminderText.value.trim();
            if (text) {
              reminders.push({ text, created: new Date().toISOString() });
              localStorage.setItem('reminders', JSON.stringify(reminders));
              reminderText.value = '';
              renderReminders();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${text}`);
              showError('reminders', '');
            } else {
              showError('reminders', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è');
            }
          } catch (e) {
            showError('reminders', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ' + e.message);
          }
        };

        window.deleteReminder = (index) => {
          try {
            const text = reminders[index].text;
            reminders.splice(index, 1);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            renderReminders();
            logActivity(`–£–¥–∞–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${text}`);
            showError('reminders', '');
          } catch (e) {
            showError('reminders', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ' + e.message);
          }
        };

        renderReminders();
      } catch (e) {
        showError('reminders', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –ó–∞–º–µ—Ç–∫–∏
    function initNotes() {
      try {
        const noteText = document.getElementById('note-text');
        const noteList = document.getElementById('note-list');
        let notes = JSON.parse(localStorage.getItem('notes') || '[]');

        const renderNotes = () => {
          try {
            noteList.innerHTML = '';
            notes.forEach((note, index) => {
              const li = document.createElement('li');
              li.innerHTML = `
                ${note.text} (${new Date(note.created).toLocaleDateString()})
                <button onclick="deleteNote(${index})">‚ùå</button>
              `;
              noteList.appendChild(li);
            });
            renderAnalytics();
            showError('notes', '');
          } catch (e) {
            showError('notes', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏: ' + e.message);
          }
        };

        window.addNote = () => {
          try {
            const text = noteText.value.trim();
            if (text) {
              notes.push({ text, created: new Date().toISOString() });
              localStorage.setItem('notes', JSON.stringify(notes));
              noteText.value = '';
              renderNotes();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞: ${text}`);
              showError('notes', '');
            } else {
              showError('notes', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏');
            }
          } catch (e) {
            showError('notes', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É: ' + e.message);
          }
        };

        window.deleteNote = (index) => {
          try {
            const text = notes[index].text;
            notes.splice(index, 1);
            localStorage.setItem('notes', JSON.stringify(notes));
            renderNotes();
            logActivity(`–£–¥–∞–ª–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞: ${text}`);
            showError('notes', '');
          } catch (e) {
            showError('notes', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É: ' + e.message);
          }
        };

        renderNotes();
      } catch (e) {
        showError('notes', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }

    // –ü—Ä–∏–≤—ã—á–∫–∏
    function initHabits() {
      try {
        const habitText = document.getElementById('habit-text');
        const habitFrequency = document.getElementById('habit-frequency');
        const habitList = document.getElementById('habit-list');
        let habits = JSON.parse(localStorage.getItem('habits') || '[]');

        const renderHabits = () => {
          try {
            habitList.innerHTML = '';
            habits.forEach((habit, index) => {
              const streak = calculateStreak(habit);
              const li = document.createElement('li');
              li.innerHTML = `
                ${habit.text} (${habit.frequency}, –°–µ—Ä–∏—è: ${streak} –¥–Ω–µ–π)
                <input type="checkbox" ${habit.todayCompleted ? 'checked' : ''} onchange="toggleHabit(${index})">
                <button onclick="deleteHabit(${index})">‚ùå</button>
              `;
              habitList.appendChild(li);
            });
            renderAnalytics();
            showError('habits', '');
          } catch (e) {
            showError('habits', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫–∏: ' + e.message);
          }
        };

        const calculateStreak = (habit) => {
          let streak = 0;
          const today = new Date().toDateString();
          let currentDate = new Date(habit.lastCompleted || today);
          while (currentDate.toDateString() === new Date(Date.now() - streak * 24 * 60 * 60 * 1000).toDateString()) {
            if (habit.completionHistory.includes(currentDate.toDateString())) streak++;
            else break;
            currentDate = new Date(currentDate - 24 * 60 * 60 * 1000);
          }
          return streak;
        };

        window.addHabit = () => {
          try {
            const text = habitText.value.trim();
            const frequency = habitFrequency.value;
            if (text) {
              habits.push({ text, frequency, completionHistory: [], lastCompleted: null, todayCompleted: false });
              localStorage.setItem('habits', JSON.stringify(habits));
              habitText.value = '';
              habitFrequency.value = 'daily';
              renderHabits();
              logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏–≤—ã—á–∫–∞: ${text}`);
              showError('habits', '');
            } else {
              showError('habits', '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–≤—ã—á–∫—É');
            }
          } catch (e) {
            showError('habits', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É: ' + e.message);
          }
        };

        window.toggleHabit = (index) => {
          try {
            const today = new Date().toDateString();
            habits[index].todayCompleted = !habits[index].todayCompleted;
            if (habits[index].todayCompleted) {
              habits[index].completionHistory.push(today);
              habits[index].lastCompleted = today;
            } else {
              habits[index].completionHistory = habits[index].completionHistory.filter(date => date !== today);
            }
            localStorage.setItem('habits', JSON.stringify(habits));
            renderHabits();
            logActivity(`–ü—Ä–∏–≤—ã—á–∫–∞ ${habits[index].text}: ${habits[index].todayCompleted ? '–í—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–û—Ç–º–µ–Ω–µ–Ω–∞'}`);
          } catch (e) {
            showError('habits', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–≤—ã—á–∫–∏: ' + e.message);
          }
        };

        window.deleteHabit = (index) => {
          try {
            const text = habits[index].text;
            habits.splice(index, 1);
            localStorage.setItem('habits', JSON.stringify(habits));
            renderHabits();
            logActivity(`–£–¥–∞–ª–µ–Ω–∞ –ø—Ä–∏–≤—ã—á–∫–∞: ${text}`);
            showError('habits', '');
          } catch (e) {
            showError('habits', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É: ' + e.message);
          }
        };

        const today = new Date().toDateString();
        if (localStorage.getItem('lastHabitReset') !== today) {
          habits.forEach(habit => {
            if (habit.frequency === 'daily') habit.todayCompleted = false;
          });
          localStorage.setItem('habits', JSON.stringify(habits));
          localStorage.setItem('lastHabitReset', today);
        }

        renderHabits();
      } catch (e) {
        showError('habits', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
      }
    }


// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function scheduleNotifications() {
      try {
        if ('Notification' in window && Notification.permission === 'granted') {
          const plans = JSON.parse(localStorage.getItem('plans') || '[]');
          const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
          const habits = JSON.parse(localStorage.getItem('habits') || '[]');
          plans.forEach(plan => {
            if (!plan.completed) {
              new Notification('BlackTrigger HQ: –ó–∞–¥–∞—á–∞', {
                body: `–ù–µ –∑–∞–±—É–¥—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å: ${plan.text} (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${plan.priority})`,
                icon: '/icon.png'
              });
            }
          });
          reminders.forEach(reminder => {
            new Notification('BlackTrigger HQ: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', {
              body: reminder.text,
              icon: '/icon.png'
            });
          });
          habits.forEach(habit => {
            if (!habit.todayCompleted && habit.frequency === 'daily') {
              new Notification('BlackTrigger HQ: –ü—Ä–∏–≤—ã—á–∫–∞', {
                body: `–ù–µ –∑–∞–±—É–¥—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å: ${habit.text}`,
                icon: '/icon.png'
              });
            }
          });
        } else if ('Notification' in window && Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              scheduleNotifications();
            }
          });
        }
      } catch (e) {
        showError('notification', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ' + e.message);
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è
    function checkInactivity() {
      try {
        const lastActivity = localStorage.getItem('lastActivity') || new Date().toISOString();
        const now = new Date();
        const diff = (now - new Date(lastActivity)) / (1000 * 60 * 60 * 24);
        const plans = JSON.parse(localStorage.getItem('plans') || '[]');
        const exercises = JSON.parse(localStorage.getItem('exercises') || '[]');
        const strategies = JSON.parse(localStorage.getItem('strategies') || '[]');
        const habits = JSON.parse(localStorage.getItem('habits') || '[]');

        if (diff >= 3 && plans.length === 0 && exercises.length === 0 && strategies.length === 0 && habits.length === 0) {
          const notification = document.getElementById('critical-notification');
          notification.style.display = 'block';
          notification.textContent = '–®—Ç–∞–±: –¢—ã —Ç–µ—Ä—è–µ—à—å –∫–æ–Ω—Ç—Ä–æ–ª—å. –î–æ–±–∞–≤—å –∑–∞–¥–∞—á—É, —Ü–µ–ª—å –∏–ª–∏ –ø—Ä–∏–≤—ã—á–∫—É. –î–µ–π—Å—Ç–≤—É–π –∏–ª–∏ –ø—Ä–æ–∏–≥—Ä–∞–µ—à—å.';
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('BlackTrigger HQ: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ', {
              body: '–¢—ã –±–µ–∑–¥–µ–π—Å—Ç–≤—É–µ—à—å 3 –¥–Ω—è. –î–æ–±–∞–≤—å –∑–∞–¥–∞—á—É, —Ü–µ–ª—å –∏–ª–∏ –ø—Ä–∏–≤—ã—á–∫—É. –î–µ–π—Å—Ç–≤—É–π!',
              icon: '/icon.png'
            });
          }
          logActivity('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –ë–µ–∑–¥–µ–π—Å—Ç–≤–∏–µ –±–æ–ª–µ–µ 3 –¥–Ω–µ–π');
        } else {
          document.getElementById('critical-notification').style.display = 'none';
        }
        localStorage.setItem('lastActivity', now.toISOString());
      } catch (e) {
        showError('notification', '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è: ' + e.message);
      }
    }

    // –ö–æ–Ω—Å–æ–ª—å Eruda
    function initEruda() {
      try {
        eruda.init();
        logActivity('–ö–æ–Ω—Å–æ–ª—å Eruda –æ—Ç–∫—Ä—ã—Ç–∞');
      } catch (e) {
        showError('settings', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å: ' + e.message);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
    document.addEventListener('DOMContentLoaded', () => {
      const mode = localStorage.getItem('mode') || 'Absolute';
      switchMode(mode);
      initRuleOfDay();
      initPlan();
      initEnvironment();
      initFinance();
      initFitness();
      initArchetype();
      initStrategy();
      initReminders();
      initKnowledge();
      initHabits();
      initNotes();
      renderAnalytics();
      checkInactivity();

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
          .then(reg => {
            console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg);
            logActivity('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
          })
          .catch(err => {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', err);
            showError('settings', '–û—à–∏–±–∫–∞ Service Worker: ' + err.message);
          });
      }
    });
  </script>
</body>
</html>