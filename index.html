<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg-color);
      color: var(--text-color);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    section {
      margin-bottom: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .finance-columns {
      display: flex;
      align-items: stretch;
      border-left: 2px solid #ccc;
      border-right: 2px solid #ccc;
    }
    .finance-columns > div {
      width: 48%;
      padding: 0 10px;
    }
    .finance-divider {
      width: 2px;
      background: #ccc;
    }
    .finance-summary {
      text-align: center;
      margin-top: 10px;
    }
    input, select, button {
      margin: 5px;
      padding: 8px;
      border-radius: 4px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #333;
        --text-color: #fff;
      }
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg-color: #fff;
        --text-color: #333;
      }
    }
    @media (max-width: 600px) {
      .finance-columns {
        flex-direction: column;
        border-left: none;
        border-right: none;
      }
      .finance-columns > div {
        width: 100%;
      }
      .finance-divider {
        height: 2px;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <section id="state">
      <h2>–°–æ—Å—Ç–æ—è–Ω–∏–µ</h2>
      <select id="state-select">
        <option value="focus">‚öñÔ∏è –í —Ñ–æ–∫—É—Å–µ</option>
        <option value="fatigue">‚ö°Ô∏è –£—Å—Ç–∞–ª–æ—Å—Ç—å</option>
        <option value="uplift">üöÄ –ü–æ–¥—ä—ë–º</option>
      </select>
      <button onclick="updateState()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </section>

    <!-- –ü—Ä–∞–≤–∏–ª–æ –¥–Ω—è -->
    <section id="rule">
      <h2>–ü—Ä–∞–≤–∏–ª–æ –¥–Ω—è</h2>
      <p id="rule-text"></p>
      <input type="text" id="new-rule" placeholder="–ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ">
      <button onclick="addRule()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
      <button onclick="nextRule()">–°–ª–µ–¥—É—é—â–µ–µ –ø—Ä–∞–≤–∏–ª–æ</button>
    </section>

    <!-- –ü–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å -->
    <section id="plan">
      <h2>–ü–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å</h2>
      <input type="text" id="task-input" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞">
      <input type="time" id="reminder-time">
      <button onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <ul id="task-list"></ul>
    </section>

    <!-- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è -->
    <section id="reminders">
      <h2>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</h2>
      <input type="time" id="reminder-time-input">
      <input type="text" id="reminder-text" placeholder="–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è">
      <button onclick="addReminder()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <ul id="reminder-list"></ul>
    </section>

    <!-- –û–∫—Ä—É–∂–µ–Ω–∏–µ -->
    <section id="environment">
      <h2>–û–∫—Ä—É–∂–µ–Ω–∏–µ</h2>
      <input type="text" id="person-name" placeholder="–ò–º—è">
      <select id="person-status">
        <option value="loyal">–õ–æ—è–ª—å–Ω—ã–π</option>
        <option value="neutral">–ù–µ–π—Ç—Ä–∞–ª</option>
        <option value="enemy">–í—Ä–∞–≥</option>
        <option value="contract">–ö–æ–Ω—Ç—Ä–∞–∫—Ç</option>
      </select>
      <select id="person-tags" multiple>
        <option value="üí∞ –†–µ—Å—É—Ä—Å">üí∞ –†–µ—Å—É—Ä—Å</option>
        <option value="ü™® –ë–∞–ª–ª–∞—Å—Ç">ü™® –ë–∞–ª–ª–∞—Å—Ç</option>
        <option value="üß† –í–Ω—É—à–∞–µ–º—ã–π">üß† –í–Ω—É—à–∞–µ–º—ã–π</option>
        <option value="üó£Ô∏è –ë–æ–ª—Ç—É–Ω">üó£Ô∏è –ë–æ–ª—Ç—É–Ω</option>
        <option value="‚úùÔ∏è –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–π">‚úùÔ∏è –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–π</option>
        <option value="üß© –ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä">üß© –ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä</option>
        <option value="üß≤ –ó–∞–≤–∏—Å—Ç–ª–∏–≤—ã–π">üß≤ –ó–∞–≤–∏—Å—Ç–ª–∏–≤—ã–π</option>
        <option value="ü¶ä –•–∏—Ç—Ä—ã–π">ü¶ä –•–∏—Ç—Ä—ã–π</option>
      </select>
      <input type="number" id="person-karma" min="-100" max="100" step="10" value="0">
      <button onclick="addPerson()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <ul id="person-list"></ul>
    section>

    <!-- –§–∏–∑–æ -->
    <section id="fitness">
      <h2>–§–∏–∑–æ</h2>
      <input type="text" id="exercise-type" placeholder="–¢–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è">
      <input type="number" id="exercise-result" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç">
      <button onclick="addExercise()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
      <ul id="exercise-list"></ul>
      <canvas id="fitness-chart"></canvas>
    </section>

    <!-- –î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã -->
    <section id="finance">
      <h2>–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã</h2>
      <input type="number" id="transaction-amount" placeholder="–°—É–º–º–∞">
      <select id="transaction-type">
        <option value="income">–î–æ—Ö–æ–¥</option>
        <option value="expense">–†–∞—Å—Ö–æ–¥</option>
      </select>
      <input type="text" id="transaction-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
      <button onclick="addTransaction()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
      <div class="finance-columns">
        <div>
          <h3>–î–æ—Ö–æ–¥—ã</h3>
          <ul id="income-list"></ul>
        </div>
        <div class="finance-divider"></div>
        <div>
          <h3>–†–∞—Å—Ö–æ–¥—ã</h3>
          <ul id="expense-list"></ul>
        </div>
      </div>
      <div class="finance-summary">
        <p id="finance-percentage"></p>
      </div>
      <button onclick="showFinanceLog()">–ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Å—å –ª–æ–≥</button>
      <canvas id="finance-chart"></canvas>
    </section>

    <!-- –ê—Ä—Ö–µ—Ç–∏–ø—ã -->
    <section id="archetypes">
      <h2>–ê—Ä—Ö–µ—Ç–∏–ø—ã</h2>
      <div id="questions"></div>
      <button onclick="submitArchetype()">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button>
      <p id="archetype-result"></p>
      <button onclick="resetArchetype()">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </section>

    <!-- –ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ -->
    <section id="strategy">
      <h2>–ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h2>
      <input type="text" id="strategy-goal" placeholder="–¶–µ–ª—å">
      <input type="text" id="strategy-levers" placeholder="–†—ã—á–∞–≥–∏">
      <input type="text" id="strategy-resources" placeholder="–†–µ—Å—É—Ä—Å—ã">
      <input type="text" id="strategy-obstacles" placeholder="–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è">
      <input type="text" id="strategy-mechanisms" placeholder="–ú–µ—Ö–∞–Ω–∏–∑–º—ã">
      <select id="strategy-people"></select>
      <select id="strategy-status">
        <option value="plan">–ü–ª–∞–Ω</option>
        <option value="in-progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
        <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
        <option value="failed">–ü—Ä–æ–≤–∞–ª–≤–∞–Ω–æ</option>
      </select>
      <button onclick="addStrategy()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <ul id="strategy-list"></ul>
    </section>

    <!-- –õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <section id="activity">
      <h2>–õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
      <button onclick="toggleActivityLog()">–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å</button>
      <ul id="activity-list" style="display: none;"></ul>
      <button onclick="undoLastAction()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      <canvas id="activity-chart"></canvas>
    </section>

    <!-- –¢–µ–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
    <section id="analytics">
      <h2>–¢–µ–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      <button onclick="renderAnalytics()">–û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É</button>
      <div id="analytics-results"></div>
    </section>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <section id="settings">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <input type="file" id="background-image" accept="image/*">
      <button onclick="setBackground()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–Ω</button>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    function logActivity(action) {
      try {
        const activity = JSON.parse(localStorage.getItem('activityLog') || '[]');
        activity.push({ date: new Date().toISOString(), action });
        localStorage.setItem('activityLog', JSON.stringify(activity));
        renderActivity();
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:', e);
      }
    }

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    function initState() {
      const stateSelect = document.getElementById('state-select');
      const savedState = localStorage.getItem('userState') || 'focus';
      stateSelect.value = savedState;

      window.updateState = () => {
        const state = stateSelect.value;
        localStorage.setItem('userState', state);
        logActivity(`–ò–∑–º–µ–Ω–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}`);
        renderAnalytics();
      };
    }

    // –ü—Ä–∞–≤–∏–ª–æ –¥–Ω—è
    const defaultRules = [
      '–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–æ–±–æ–π ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –≤—Å–µ–º',
      '–î–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —Ç–æ, —á—Ç–æ –º–æ–∂–µ—à—å –æ—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ –∑–∞–≤—Ç—Ä–∞',
      '–ö–∞–∂–¥—ã–π —à–∞–≥ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –∫ —Ü–µ–ª–∏',
      '–ë—É–¥—å –≥–∏–±–∫–∏–º, –Ω–æ –Ω–µ –ª–æ–º–∞–π—Å—è',
      '–°–∏–ª–∞ –≤ –ø—Ä–æ—Å—Ç–æ—Ç–µ',
      '–û—à–∏–±–∫–∏ ‚Äî —ç—Ç–æ —É—Ä–æ–∫–∏',
      '–î–µ–π—Å—Ç–≤—É–π, –∞ –Ω–µ –º–µ—á—Ç–∞–π',
      '–ë—É–¥—å –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–º–µ–Ω–∞–º',
      '–¶–µ–Ω–∏ –≤—Ä–µ–º—è, –æ–Ω–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è',
      '–°–ª—É—à–∞–π –±–æ–ª—å—à–µ, –≥–æ–≤–æ—Ä–∏ –º–µ–Ω—å—à–µ'
    ];

    function initRule() {
      const ruleText = document.getElementById('rule-text');
      const newRuleInput = document.getElementById('new-rule');
      let rules = JSON.parse(localStorage.getItem('rules') || '[]').concat(defaultRules);
      let currentRuleIndex = 0;

      const displayRule = () => {
        ruleText.textContent = rules[currentRuleIndex] || '–ù–µ—Ç –ø—Ä–∞–≤–∏–ª';
      };

      window.addRule = () => {
        const newRule = newRuleInput.value.trim();
        if (newRule) {
          rules.push(newRule);
          localStorage.setItem('rules', JSON.stringify(rules));
          newRuleInput.value = '';
          displayRule();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ: ${newRule}`);
        }
      };

      window.nextRule = () => {
        currentRuleIndex = (currentRuleIndex + 1) % rules.length;
        displayRule();
        logActivity('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ');
      };

      displayRule();
    }

    // –ü–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å
    function initPlan() {
      const taskInput = document.getElementById('task-input');
      const reminderTime = document.getElementById('reminder-time');
      const taskList = document.getElementById('task-list');
      let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');

      const renderTasks = () => {
        taskList.innerHTML = '';
        tasks.forEach((task, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${index})">
            ${task.text} (${task.time || '–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏'})
            <button onclick="deleteTask(${index})">‚ùå</button>
          `;
          taskList.appendChild(li);
        });
      };

      window.addTask = () => {
        const text = taskInput.value.trim();
        const time = reminderTime.value;
        if (text) {
          tasks.push({ text, time, completed: false, created: new Date().toISOString() });
          localStorage.setItem('tasks', JSON.stringify(tasks));
          taskInput.value = '';
          reminderTime.value = '';
          renderTasks();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞: ${text}`);
          if (time) scheduleNotification(text, time);
        }
      };

      window.toggleTask = (index) => {
        tasks[index].completed = !tasks[index].completed;
        localStorage.setItem('tasks', JSON.stringify(tasks));
        renderTasks();
        logActivity(`–ó–∞–¥–∞—á–∞ "${tasks[index].text}" ${tasks[index].completed ? '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'}`);
      };

      window.deleteTask = (index) => {
        const taskText = tasks[index].text;
        tasks.splice(index, 1);
        localStorage.setItem('tasks', JSON.stringify(tasks));
        renderTasks();
        logActivity(`–£–¥–∞–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞: ${taskText}`);
      };

      function scheduleNotification(text, time) {
        const [hours, minutes] = time.split(':').map(Number);
        const now = new Date();
        const notificationTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
        const delay = notificationTime - now;
        if (delay > 0) {
          setTimeout(() => {
            if (Notification.permission === 'granted') {
              new Notification(text);
            }
          }, delay);
        }
      }

      renderTasks();
    }

    // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    function initReminders() {
      const reminderTimeInput = document.getElementById('reminder-time-input');
      const reminderTextInput = document.getElementById('reminder-text');
      const reminderList = document.getElementById('reminder-list');
      let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');

      const renderReminders = () => {
        reminderList.innerHTML = '';
        reminders.forEach((reminder, index) => {
          const li = document.createElement('li');
          li.innerHTML = `${reminder.time} - ${reminder.text} <button onclick="deleteReminder(${index})">‚ùå</button>`;
          reminderList.appendChild(li);
        });
      };

      window.addReminder = () => {
        const time = reminderTimeInput.value;
        const text = reminderTextInput.value.trim();
        if (time && text) {
          reminders.push({ time, text });
          localStorage.setItem('reminders', JSON.stringify(reminders));
          reminderTimeInput.value = '';
          reminderTextInput.value = '';
          renderReminders();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${text}`);
          scheduleNotification(text, time);
        }
      };

      window.deleteReminder = (index) => {
        const reminderText = reminders[index].text;
        reminders.splice(index, 1);
        localStorage.setItem('reminders', JSON.stringify(reminders));
        renderReminders();
        logActivity(`–£–¥–∞–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${reminderText}`);
      };

      function scheduleNotification(text, time) {
        const [hours, minutes] = time.split(':').map(Number);
        const now = new Date();
        const notificationTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
        const delay = notificationTime - now;
        if (delay > 0) {
          setTimeout(() => {
            if (Notification.permission === 'granted') {
              new Notification(text);
            }
          }, delay);
        }
      }

      renderReminders();

      if (Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
    }

    // –û–∫—Ä—É–∂–µ–Ω–∏–µ
    function initEnvironment() {
      const personName = document.getElementById('person-name');
      const personStatus = document.getElementById('person-status');
      const personTags = document.getElementById('person-tags');
      const personKarma = document.getElementById('person-karma');
      const personList = document.getElementById('person-list');
      let people = JSON.parse(localStorage.getItem('people') || '[]');

      const renderPeople = () => {
        personList.innerHTML = '';
        people.forEach((person, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            ${person.name} (${person.status}, –ö–∞—Ä–º–∞: ${person.karma}, –ú–µ—Ç–∫–∏: ${person.tags.join(', ')})
            <button onclick="adjustKarma(${index}, 10)">+10</button>
            <button onclick="adjustKarma(${index}, -10)">-10</button>
            <button onclick="deletePerson(${index})">‚ùå</button>
          `;
          personList.appendChild(li);
        });
        updateStrategyPeopleSelect();
      };

      window.addPerson = () => {
        const name = personName.value.trim();
        const status = personStatus.value;
        const tags = Array.from(personTags.selectedOptions).map(opt => opt.value);
        const karma = parseInt(personKarma.value) || 0;
        if (name) {
          people.push({ name, status, tags, karma });
          localStorage.setItem('people', JSON.stringify(people));
          personName.value = '';
          personTags.value = '';
          personKarma.value = '0';
          renderPeople();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω —á–µ–ª–æ–≤–µ–∫: ${name}`);
          renderAnalytics();
        }
      };

      window.adjustKarma = (index, change) => {
        people[index].karma = Math.max(-100, Math.min(100, people[index].karma + change));
        localStorage.setItem('people', JSON.stringify(people));
        renderPeople();
        logActivity(`–ò–∑–º–µ–Ω–µ–Ω–∞ –∫–∞—Ä–º–∞ –¥–ª—è ${people[index].name}: ${people[index].karma}`);
        renderAnalytics();
      };

      window.deletePerson = (index) => {
        const name = people[index].name;
        people.splice(index, 1);
        localStorage.setItem('people', JSON.stringify(people));
        renderPeople();
        logActivity(`–£–¥–∞–ª—ë–Ω —á–µ–ª–æ–≤–µ–∫: ${name}`);
        renderAnalytics();
      };

      renderPeople();
    }

    // –§–∏–∑–æ
    function initFitness() {
      const exerciseType = document.getElementById('exercise-type');
      const exerciseResult = document.getElementById('exercise-result');
      const exerciseList = document.getElementById('exercise-list');
      const fitnessChart = document.getElementById('fitness-chart').getContext('2d');
      let exercises = JSON.parse(localStorage.getItem('exercises') || '[]');
      let chart;

      const renderExercises = () => {
        exerciseList.innerHTML = '';
        exercises.forEach((exercise, index) => {
          const li = document.createElement('li');
          li.innerHTML = `${exercise.type}: ${exercise.result} (${new Date(exercise.date).toLocaleDateString()}) <button onclick="deleteExercise(${index})">‚ùå</button>`;
          exerciseList.appendChild(li);
        });
        updateFitnessChart();
      };

      window.addExercise = () => {
        const type = exerciseType.value.trim();
        const result = parseFloat(exerciseResult.value);
        if (type && !isNaN(result)) {
          exercises.push({ type, result, date: new Date().toISOString() });
          localStorage.setItem('exercises', JSON.stringify(exercises));
          exerciseType.value = '';
          exerciseResult.value = '';
          renderExercises();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: ${type}, ${result}`);
        }
      };

      window.deleteExercise = (index) => {
        const exerciseType = exercises[index].type;
        exercises.splice(index, 1);
        localStorage.setItem('exercises', JSON.stringify(exercises));
        renderExercises();
        logActivity(`–£–¥–∞–ª–µ–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: ${exerciseType}`);
      };

      function updateFitnessChart() {
        const types = [...new Set(exercises.map(ex => ex.type))];
        const datasets = types.map(type => ({
          label: type,
          data: exercises.filter(ex => ex.type === type).map(ex => ex.result),
          backgroundColor: `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.5)`
        }));

        if (chart) chart.destroy();
        chart = new Chart(fitnessChart, {
          type: 'bar',
          data: {
            labels: exercises.map(ex => new Date(ex.date).toLocaleDateString()),
            datasets
          },
          options: { scales: { y: { beginAtZero: true } } }
        });
      }

      renderExercises();
    }

    // –î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã
    function initFinance() {
      const amountInput = document.getElementById('transaction-amount');
      const typeSelect = document.getElementById('transaction-type');
      const descriptionInput = document.getElementById('transaction-description');
      const incomeList = document.getElementById('income-list');
      const expenseList = document.getElementById('expense-list');
      const percentageText = document.getElementById('finance-percentage');
      const financeChart = document.getElementById('finance-chart').getContext('2d');
      let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
      let chart;

      const renderTransactions = () => {
        incomeList.innerHTML = '';
        expenseList.innerHTML = '';
        const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
        const recentTransactions = transactions.filter(t => new Date(t.date) >= last30Days);

        recentTransactions.forEach((transaction, index) => {
          const li = document.createElement('li');
          li.innerHTML = `${transaction.amount} - ${transaction.description} <button onclick="deleteTransaction(${index})">‚ùå</button>`;
          if (transaction.type === 'income') {
            incomeList.appendChild(li);
          } else {
            expenseList.appendChild(li);
          }
        });

        const income = recentTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expense = recentTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const total = income + expense;
        const percentage = total ? (income / total * 100).toFixed(2) : 0;
        percentageText.textContent = `–î–æ—Ö–æ–¥—ã: ${income}, –†–∞—Å—Ö–æ–¥—ã: ${expense}, –ü—Ä–æ—Ü–µ–Ω—Ç: ${percentage}%`;
        percentageText.style.color = percentage > 50 ? 'green' : percentage === 50 ? 'yellow' : 'red';

        updateFinanceChart();
      };

      window.addTransaction = () => {
        const amount = parseFloat(amountInput.value);
        const type = typeSelect.value;
        const description = descriptionInput.value.trim();
        if (!isNaN(amount) && description) {
          transactions.push({ amount, type, description, date: new Date().toISOString() });
          localStorage.setItem('transactions', JSON.stringify(transactions));
          amountInput.value = '';
          descriptionInput.value = '';
          renderTransactions();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: ${type}, ${amount}`);
          renderAnalytics();
        }
      };

      window.deleteTransaction = (index) => {
        const transaction = transactions[index];
        transactions.splice(index, 1);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        renderTransactions();
        logActivity(`–£–¥–∞–ª–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: ${transaction.type}, ${transaction.amount}`);
        renderAnalytics();
      };

      window.showFinanceLog = () => {
        alert(JSON.stringify(transactions, null, 2));
        logActivity('–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω –ª–æ–≥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
      };

      function updateFinanceChart() {
        const dates = [...new Set(transactions.map(t => new Date(t.date).toLocaleDateString()))];
        const incomeData = dates.map(date => {
          return transactions
            .filter(t => t.type === 'income' && new Date(t.date).toLocaleDateString() === date)
            .reduce((sum, t) => sum + t.amount, 0);
        });
        const expenseData = dates.map(date => {
          return transactions
            .filter(t => t.type === 'expense' && new Date(t.date).toLocaleDateString() === date)
            .reduce((sum, t) => sum + t.amount, 0);
        });

        if (chart) chart.destroy();
        chart = new Chart(financeChart, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              { label: '–î–æ—Ö–æ–¥—ã', data: incomeData, borderColor: 'green', fill: false },
              { label: '–†–∞—Å—Ö–æ–¥—ã', data: expenseData, borderColor: 'red', fill: false }
            ]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });
      }

      renderTransactions();
    }

    // –ê—Ä—Ö–µ—Ç–∏–ø—ã
    const questions = [
      { text: '–ö–∞–∫ –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —Ä–µ—à–µ–Ω–∏—è?', options: ['–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ', '–°–ª—É—à–∞—é –∏–Ω—Ç—É–∏—Ü–∏—é', '–°–æ–≤–µ—Ç—É—é—Å—å —Å –¥—Ä—É–≥–∏–º–∏'] },
      { text: '–í –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –≤—ã:', options: ['–ò–¥—ë—Ç–µ –Ω–∞ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å', '–ù–∞—Å—Ç–∞–∏–≤–∞–µ—Ç–µ –Ω–∞ —Å–≤–æ—ë–º', '–ò–∑–±–µ–≥–∞–µ—Ç–µ'] },
      { text: '–í–∞—à–∞ —Ü–µ–ª—å:', options: ['–î–æ—Å—Ç–∏—á—å –≤–ª–∞—Å—Ç–∏', '–°–æ–∑–¥–∞—Ç—å –≥–∞—Ä–º–æ–Ω–∏—é', '–†–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏'] },
      { text: '–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Ä–∏—Å–∫—É:', options: ['–õ—é–±–ª—é —Ä–∏—Å–∫', '–ò–∑–±–µ–≥–∞—é —Ä–∏—Å–∫', '–†–∏—Å–∫—É—é —Å —Ä–∞—Å—á–µ—Ç–æ–º'] },
      { text: '–í–∞—à–∞ —Ä–æ–ª—å –≤ –∫–æ–º–∞–Ω–¥–µ:', options: ['–õ–∏–¥–µ—Ä', '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', '–ò—Å–∫—Ä—ã –∏–¥–µ–π'] }
    ];

    const archetypes = ['–•–∏—â–Ω–∏–∫', '–°—Ç—Ä–∞—Ç–µ–≥', '–ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä', '–û—Ä–∞–∫—É–ª', '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', '–ú–µ–¥–∏–∞—Ç–æ—Ä'];

    function initArchetypes() {
      const questionsDiv = document.getElementById('questions');
      const resultText = document.getElementById('archetype-result');
      let answers = JSON.parse(localStorage.getItem('archetypeAnswers') || '[]');

      const renderQuestions = () => {
        questionsDiv.innerHTML = '';
        questions.forEach((q, index) => {
          const div = document.createElement('div');
          div.innerHTML = `<p>${q.text}</p>`;
          q.options.forEach((option, i) => {
            const button = document.createElement('button');
            button.textContent = option;
            button.onclick = () => selectAnswer(index, i);
            div.appendChild(button);
          });
          questionsDiv.appendChild(div);
        });
      };

      window.selectAnswer = (questionIndex, optionIndex) => {
        answers[questionIndex] = optionIndex;
        localStorage.setItem('archetypeAnswers', JSON.stringify(answers));
        logActivity(`–í—ã–±—Ä–∞–Ω –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å ${questionIndex + 1}`);
        renderQuestions();
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        const buttons = questionsDiv.children[questionIndex].getElementsByTagName('button');
        for (let btn of buttons) btn.style.background = '#007bff';
        buttons[optionIndex].style.background = '#0056b3';
      };

      window.submitArchetype = () => {
        if (answers.length === questions.length) {
          // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞—Ä—Ö–µ—Ç–∏–ø–∞
          const score = answers.reduce((sum, val) => sum + val, 0);
          const archetype = archetypes[Math.floor(score % archetypes.length)];
          resultText.textContent = `–í–∞—à –∞—Ä—Ö–µ—Ç–∏–ø: ${archetype}. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${getArchetypeRecommendation(archetype)}`;
          localStorage.setItem('archetype', archetype);
          logActivity(`–û–ø—Ä–µ–¥–µ–ª—ë–Ω –∞—Ä—Ö–µ—Ç–∏–ø: ${archetype}`);
        } else {
          alert('–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã');
        }
      };

      window.resetArchetype = () => {
        answers = [];
        localStorage.removeItem('archetypeAnswers');
        localStorage.removeItem('archetype');
        resultText.textContent = '';
        renderQuestions();
        logActivity('–°–±—Ä–æ—à–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤');
      };

      function getArchetypeRecommendation(archetype) {
        const recommendations = {
          '–•–∏—â–Ω–∏–∫': '–§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –ª–∏–¥–µ—Ä—Å—Ç–≤–µ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ.',
          '–°—Ç—Ä–∞—Ç–µ–≥': '–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —à–∞–≥–∏.',
          '–ü—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è.',
          '–û—Ä–∞–∫—É–ª': '–î–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ç—É–∏—Ü–∏–∏.',
          '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å': '–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á.',
          '–ú–µ–¥–∏–∞—Ç–æ—Ä': '–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥–∞—Ä–º–æ–Ω–∏—é –≤ –∫–æ–º–∞–Ω–¥–µ.'
        };
        return recommendations[archetype] || '–î–µ–π—Å—Ç–≤—É–π—Ç–µ –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏.';
      }

      renderQuestions();
      const savedArchetype = localStorage.getItem('archetype');
      if (savedArchetype) {
        resultText.textContent = `–í–∞—à –∞—Ä—Ö–µ—Ç–∏–ø: ${savedArchetype}. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${getArchetypeRecommendation(savedArchetype)}`;
      }
    }

    // –ö–∞—Ä—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    function initStrategy() {
      const goalInput = document.getElementById('strategy-goal');
      const leversInput = document.getElementById('strategy-levers');
      const resourcesInput = document.getElementById('strategy-resources');
      const obstaclesInput = document.getElementById('strategy-obstacles');
      const mechanismsInput = document.getElementById('strategy-mechanisms');
      const peopleSelect = document.getElementById('strategy-people');
      const statusSelect = document.getElementById('strategy-status');
      const strategyList = document.getElementById('strategy-list');
      let strategies = JSON.parse(localStorage.getItem('strategies') || '[]');

      window.updateStrategyPeopleSelect = () => {
        const people = JSON.parse(localStorage.getItem('people') || '[]');
        peopleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞</option>';
        people.forEach(person => {
          const option = document.createElement('option');
          option.value = person.name;
          option.textContent = person.name;
          peopleSelect.appendChild(option);
        });
      };

      const renderStrategies = () => {
        strategyList.innerHTML = '';
        strategies.forEach((strategy, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            ${strategy.goal} (${strategy.status}, –õ—é–¥–∏: ${strategy.people || '–Ω–µ—Ç'})
            <button onclick="deleteStrategy(${index})">‚ùå</button>
          `;
          strategyList.appendChild(li);
        });
      };

      window.addStrategy = () => {
        const goal = goalInput.value.trim();
        const levers = leversInput.value.trim();
        const resources = resourcesInput.value.trim();
        const obstacles = obstaclesInput.value.trim();
        const mechanisms = mechanismsInput.value.trim();
        const people = peopleSelect.value;
        const status = statusSelect.value;
        if (goal) {
          strategies.push({ goal, levers, resources, obstacles, mechanisms, people, status });
          localStorage.setItem('strategies', JSON.stringify(strategies));
          goalInput.value = '';
          leversInput.value = '';
          resourcesInput.value = '';
          obstaclesInput.value = '';
          mechanismsInput.value = '';
          peopleSelect.value = '';
          renderStrategies();
          logActivity(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: ${goal}`);
          renderAnalytics();
        } else {
          alert('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏');
        }
      };

      window.deleteStrategy = (index) => {
        const goal = strategies[index].goal;
        strategies.splice(index, 1);
        localStorage.setItem('strategies', JSON.stringify(strategies));
        renderStrategies();
        logActivity(`–£–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: ${goal}`);
        renderAnalytics();
      };

      updateStrategyPeopleSelect();
      renderStrategies();
    }

    // –õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    function initActivity() {
      const activityList = document.getElementById('activity-list');
      const activityChart = document.getElementById('activity-chart').getContext('2d');
      let activity = JSON.parse(localStorage.getItem('activityLog') || '[]');
      let chart;

      window.renderActivity = () => {
        activityList.innerHTML = '';
        activity.forEach((log, index) => {
          const li = document.createElement('li');
          li.textContent = `${new Date(log.date).toLocaleString()} - ${log.action}`;
          activityList.appendChild(li);
        });
        updateActivityChart();
      };

      window.toggleActivityLog = () => {
        activityList.style.display = activityList.style.display === 'none' ? 'block' : 'none';
        logActivity('–ü–µ—Ä–µ–∫–ª—é—á—ë–Ω –ª–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏');
      };

      window.undoLastAction = () => {
        if (activity.length > 0) {
          const lastAction = activity.pop();
          localStorage.setItem('activityLog', JSON.stringify(activity));
          renderActivity();
          logActivity(`–û—Ç–º–µ–Ω–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ: ${lastAction.action}`);
        }
      };

      function updateActivityChart() {
        const dates = [...new Set(activity.map(log => new Date(log.date).toLocaleDateString()))];
        const data = dates.map(date => {
          return activity.filter(log => new Date(log.date).toLocaleDateString() === date).length;
        });

        if (chart) chart.destroy();
        chart = new Chart(activityChart, {
          type: 'bar',
          data: {
            labels: dates,
            datasets: [{ label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', data, backgroundColor: 'rgba(0, 123, 255, 0.5)' }]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });
      }

      renderActivity();
    }

// –¢–µ–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
    function initAnalytics() {
      const analyticsResults = document.getElementById('analytics-results');

      window.renderAnalytics = () => {
        const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        const people = JSON.parse(localStorage.getItem('people') || '[]');
        const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        const state = localStorage.getItem('userState') || 'focus';
        const now = new Date();
        const threeDaysAgo = new Date(now - 3 * 24 * 60 * 60 * 1000);

        let results = '<h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3><ul>';

        // –ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
        const overdueTasks = tasks.filter(task => !task.completed && new Date(task.created) < threeDaysAgo);
        if (overdueTasks.length > 0) {
          results += `<li>–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (>3 –¥–Ω–µ–π): ${overdueTasks.map(t => t.text).join(', ')}</li>`;
        } else {
          results += '<li>–ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</li>';
        }

        // –õ—é–¥–∏ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π –∫–∞—Ä–º–æ–π
        const negativeKarma = people.filter(p => p.karma < 0);
        if (negativeKarma.length > 0) {
          results += `<li>–õ—é–¥–∏ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π –∫–∞—Ä–º–æ–π: ${negativeKarma.map(p => `${p.name} (${p.karma})`).join(', ')}</li>`;
        } else {
          results += '<li>–ù–µ—Ç –ª—é–¥–µ–π —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π –∫–∞—Ä–º–æ–π</li>';
        }

        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª—é–¥—è–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç–æ–∫
        const tagRecommendations = {
          'üí∞ –†–µ—Å—É—Ä—Å': '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Ç–µ—Å–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.',
          'ü™® –ë–∞–ª–ª–∞—Å—Ç': '–°–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫ –º–∏–Ω–∏–º—É–º—É.',
          'üß† –í–Ω—É—à–∞–µ–º—ã–π': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è —Å–≤–æ–∏—Ö –∏–¥–µ–π.',
          'üó£Ô∏è –ë–æ–ª—Ç—É–Ω': '–ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.',
          '‚úùÔ∏è –†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–π': '–£–≤–∞–∂–∞–π—Ç–µ —É–±–µ–∂–¥–µ–Ω–∏—è, –∏–∑–±–µ–≥–∞–π—Ç–µ —Å–ø–æ—Ä–æ–≤.',
          'üß© –ú–∞–Ω–∏–ø—É–ª—è—Ç–æ—Ä': '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, –∏–∑–±–µ–≥–∞–π—Ç–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π.',
          'üß≤ –ó–∞–≤–∏—Å—Ç–ª–∏–≤—ã–π': '–ù–µ –¥–µ–ª–∏—Ç–µ—Å—å —É—Å–ø–µ—Ö–∞–º–∏ –æ—Ç–∫—Ä—ã—Ç–æ.',
          'ü¶ä –•–∏—Ç—Ä—ã–π': '–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∏ –¥–µ–π—Å—Ç–≤–∏—è.'
        };

        people.forEach(person => {
          person.tags.forEach(tag => {
            if (tagRecommendations[tag]) {
              results += `<li>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è ${person.name} (${tag}): ${tagRecommendations[tag]}</li>`;
            }
          });
        });

        // –í–ª–∏—è–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        results += `<li>–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${state}. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${state === 'fatigue' ? '–û—Ç–¥–æ—Ö–Ω–∏—Ç–µ' : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ'}</li>`;

        // –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        const last30Days = new Date(now - 30 * 24 * 60 * 60 * 1000);
        const recentTransactions = transactions.filter(t => new Date(t.date) >= last30Days);
        const income = recentTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expense = recentTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const total = income + expense;
        const percentage = total ? (income / total * 100).toFixed(2) : 0;
        results += `<li>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${percentage}% (${percentage > 50 ? '–•–æ—Ä–æ—à–æ' : '–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è'})</li>`;

        results += '</ul>';
        analyticsResults.innerHTML = results;
        logActivity('–û–±–Ω–æ–≤–ª–µ–Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞');
      };

      renderAnalytics();
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    function initSettings() {
      const backgroundInput = document.getElementById('background-image');

      window.setBackground = () => {
        const file = backgroundInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            document.body.style.backgroundImage = `url(${reader.result})`;
            localStorage.setItem('background', reader.result);
            logActivity('–ò–∑–º–µ–Ω—ë–Ω —Ñ–æ–Ω');
          };
          reader.readAsDataURL(file);
        }
      };

      const savedBackground = localStorage.getItem('background');
      if (savedBackground) {
        document.body.style.backgroundImage = `url(${savedBackground})`;
      }
    }

    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function checkInactivity() {
      const activity = JSON.parse(localStorage.getItem('activityLog') || '[]');
      const lastActivity = activity.length > 0 ? new Date(activity[activity.length - 1].date) : new Date();
      const now = new Date();
      const threeDays = 3 * 24 * 60 * 60 * 1000;
      if (now - lastActivity > threeDays && Notification.permission === 'granted') {
        new Notification('–í—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã 3 –¥–Ω—è! –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –∑–∞–¥–∞—á–∞–º.');
      }
      setTimeout(checkInactivity, 24 * 60 * 60 * 1000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      try {
        initState();
        initRule();
        initPlan();
        initReminders();
        initEnvironment();
        initFitness();
        initFinance();
        initArchetypes();
        initStrategy();
        initActivity();
        initAnalytics();
        initSettings();
        checkInactivity();

        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('Service Worker registered', reg))
            .catch(err => console.error('Service Worker registration failed', err));
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
      }
    });
  </script>
</body>
</html>